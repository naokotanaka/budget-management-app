#!/bin/bash

# æœ¬ç•ªç’°å¢ƒç°¡æ˜“ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¹ã‚¯ãƒªãƒ—ãƒˆ - NPOäºˆç®—ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã€ŒãªãŒã„ãã€
# ------------------------------------------------------
# ã“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯ã€Œæ—¥å¸¸çš„ãªè»½å¾®ãªä¿®æ­£ãƒ»æ›´æ–°ã€ã‚’æœ¬ç•ªç’°å¢ƒã«åæ˜ ã™ã‚‹ãŸã‚ã®ã‚‚ã®ã§ã™ã€‚
# é‡å¤§ãªå¤‰æ›´ï¼ˆDBã‚¹ã‚­ãƒ¼ãƒå¤‰æ›´ãƒ»ä¾å­˜é–¢ä¿‚è¿½åŠ ãƒ»åˆå›ãƒ‡ãƒ—ãƒ­ã‚¤ç­‰ï¼‰ã«ã¯çµ¶å¯¾ã«ä½¿ã‚ãªã„ã§ãã ã•ã„ã€‚
# è©³ç´°ãªé‹ç”¨æ‰‹é †ã‚„æ³¨æ„ç‚¹ã¯ docs/æœ¬ç•ªç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤ã‚¬ã‚¤ãƒ‰.md ã‚’å¿…ãšå‚ç…§ã—ã¦ãã ã•ã„ã€‚
# 
# ã€ä½¿ã†ã¹ãã‚¿ã‚¤ãƒŸãƒ³ã‚°ä¾‹ã€‘
# ãƒ»å°ã•ãªãƒã‚°ä¿®æ­£ã‚„æ–‡è¨€ä¿®æ­£
# ãƒ»æ—¢å­˜æ©Ÿèƒ½ã®è»½å¾®ãªã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆ
#
# ã€ä½¿ã£ã¦ã¯ã„ã‘ãªã„ã‚¿ã‚¤ãƒŸãƒ³ã‚°ä¾‹ã€‘
# ãƒ»DBæ§‹é€ å¤‰æ›´ã‚„å¤§è¦æ¨¡ãƒªãƒ•ã‚¡ã‚¯ã‚¿
# ãƒ»ä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®è¿½åŠ /æ›´æ–°
# ãƒ»åˆå›ãƒ‡ãƒ—ãƒ­ã‚¤ã‚„æœ¬ç•ªç’°å¢ƒã®åˆæœŸæ§‹ç¯‰
#
# AIã‚„ä»–ã®é–‹ç™ºè€…ã‚‚ã€å®Ÿè¡Œå‰ã«å¿…ãšã‚¬ã‚¤ãƒ‰ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

set -e  # ã‚¨ãƒ©ãƒ¼æ™‚ã«åœæ­¢

echo "âš¡ ç°¡å˜ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’é–‹å§‹ã—ã¾ã™..."

# å¼•æ•°ãƒã‚§ãƒƒã‚¯
COMMIT_MESSAGE="${1:-fix: è»½å¾®ãªä¿®æ­£ã¨ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆ}"

echo "ğŸ“ ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: $COMMIT_MESSAGE"

# é–‹ç™ºç’°å¢ƒåœæ­¢
echo "ğŸ›‘ é–‹ç™ºç’°å¢ƒã‚’åœæ­¢ä¸­..."
./stop_development.sh 2>/dev/null || true

# Gitæ“ä½œ
echo "ğŸ“¤ Gitæ›´æ–°ä¸­..."
git add .
git commit -m "$COMMIT_MESSAGE" || echo "âš ï¸  ã‚³ãƒŸãƒƒãƒˆå¯¾è±¡ãªã—ï¼ˆæ—¢ã«ã‚³ãƒŸãƒƒãƒˆæ¸ˆã¿ï¼‰"
git push origin main

# æœ¬ç•ªç’°å¢ƒã®æ›´æ–°ç¢ºèª
echo ""
echo "ğŸš€ æœ¬ç•ªç’°å¢ƒã‚’æ›´æ–°ã—ã¾ã™ã‹ï¼Ÿ"
echo "  å®Ÿè¡Œå†…å®¹:"
echo "  1. æœ€æ–°ã‚³ãƒ¼ãƒ‰ã‚’å–å¾— (git pull)"
echo "  2. æœ¬ç•ªãƒ“ãƒ«ãƒ‰ã‚’å®Ÿè¡Œ"
echo "  3. ã‚µãƒ¼ãƒ“ã‚¹ã‚’å†èµ·å‹•"
echo ""
read -p "ç¶šè¡Œã—ã¾ã™ã‹ï¼Ÿ (y/N): " -n 1 -r
echo

if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    echo "âŒ ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸã€‚"
    exit 0
fi

# æœ¬ç•ªç’°å¢ƒæ›´æ–°ï¼ˆrootæ¨©é™å¿…è¦ï¼‰
echo "ğŸ”‘ rootæ¨©é™ã§æœ¬ç•ªç’°å¢ƒã‚’æ›´æ–°ã—ã¾ã™..."

sudo bash -c "
set -e
cd /home/tanaka/nagaiku-budget

echo 'ğŸ“¥ æœ€æ–°ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—ä¸­...'
git pull origin main

echo 'ğŸ—ï¸  æœ¬ç•ªãƒ“ãƒ«ãƒ‰å®Ÿè¡Œä¸­...'
./build_production.sh

echo 'ğŸ”„ ã‚µãƒ¼ãƒ“ã‚¹å†èµ·å‹•ä¸­...'
systemctl restart nagaiku-budget-backend
sleep 3
systemctl restart nagaiku-budget-frontend
sleep 3

echo 'âœ… ã‚µãƒ¼ãƒ“ã‚¹çŠ¶æ…‹ç¢ºèª:'
systemctl status nagaiku-budget-backend --no-pager | head -3
systemctl status nagaiku-budget-frontend --no-pager | head -3
"

# å‹•ä½œç¢ºèª
echo ""
echo "ğŸ” å‹•ä½œç¢ºèªä¸­..."

# ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
if curl -s -I http://160.251.170.97:8000/docs | grep -q "200 OK"; then
    echo "âœ… ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰API: æ­£å¸¸"
else
    echo "âŒ ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰API: ã‚¨ãƒ©ãƒ¼"
fi

if curl -s -I http://160.251.170.97:3000 | grep -q "200 OK"; then
    echo "âœ… ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰: æ­£å¸¸"
else
    echo "âŒ ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰: ã‚¨ãƒ©ãƒ¼"
fi

# å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
echo ""
echo "ğŸ‰ ç°¡å˜ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå®Œäº†ã—ã¾ã—ãŸï¼"
echo ""
echo "ğŸ“‹ ç¢ºèªURL:"
echo "  ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰: http://160.251.170.97:3000"
echo "  APIä»•æ§˜æ›¸: http://160.251.170.97:8000/docs"
echo ""
echo "ğŸ“Š ãƒ­ã‚°ç¢ºèªï¼ˆå¿…è¦æ™‚ï¼‰:"
echo "  sudo journalctl -u nagaiku-budget-backend -f"
echo "  sudo journalctl -u nagaiku-budget-frontend -f"
echo ""
echo "âš ï¸  å•é¡ŒãŒã‚ã‚‹å ´åˆã¯å®Œå…¨ãƒ‡ãƒ—ãƒ­ã‚¤æ‰‹é †ã‚’å‚ç…§ã—ã¦ãã ã•ã„:"
echo "  docs/æœ¬ç•ªç’°å¢ƒç°¡æ˜“ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¬ã‚¤ãƒ‰.md" 
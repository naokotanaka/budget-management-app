# 開発環境起動ガイド - NPO予算管理システム「ながいく」

**最終更新日**: 2024年7月21日  
**作成者**: AI開発セッション記録

---

## 🎯 概要

NPO予算管理システム「ながいく」の開発環境には、3つの起動方法があります。
用途に応じて最適な方法を選択してください。

## 📋 環境設定

### ポート設定
- **開発環境**: フロントエンド:3001, バックエンド:8001
- **本番環境**: フロントエンド:3000, バックエンド:8000

### アクセスURL
- **フロントエンド**: http://160.251.170.97:3001
- **バックエンドAPI**: http://160.251.170.97:8001
- **API仕様書**: http://160.251.170.97:8001/docs

---

## 🚀 開発環境起動方法

### 方法1: バックグラウンド実行（推奨）
**ファイル**: `start_development.sh`

#### 特徴
- ✅ バックグラウンド実行（nohup使用）
- ✅ PID管理（自動停止対応）
- ✅ ログファイル出力
- ✅ ターミナル即座解放
- ✅ 他作業と並行可能

#### 実行方法
```bash
# 起動
./start_development.sh

# 停止
./stop_development.sh
```

#### ログ確認
```bash
# リアルタイムログ確認
tail -f logs/backend_dev.log
tail -f logs/frontend_dev.log
```

#### 適用場面
- **通常の開発作業**
- **安定した環境での作業**
- **他のコマンドと並行実行**

---

### 方法2: 高機能tmux版（デバッグ推奨）
**ファイル**: `start_dev_tmux.sh`

#### 特徴
- 🛡️ 既存セッション自動停止
- 🔄 仮想環境自動検出
- 💬 詳細情報表示
- ❓ アタッチ選択式
- 📋 包括的環境変数設定

#### 実行方法
```bash
# 起動
./start_dev_tmux.sh

# アタッチするか選択
# y → 画面分割表示
# N → バックグラウンド実行

# 手動アタッチ
tmux attach -t dev-env

# 停止
./stop_development.sh
```

#### tmux操作
```bash
# ペイン切り替え: Ctrl+B → O
# デタッチ: Ctrl+B → D
# セッション確認: tmux list-sessions
```

#### 適用場面
- **初回起動時**
- **デバッグ作業**
- **エラー監視が必要**
- **安全な起動が必要**

---

### 方法3: シンプルtmux版（高速起動）
**ファイル**: `start_dev_next_time.sh`

#### 特徴
- ⚡ 即座起動（確認なし）
- 🎯 最小限設定
- 💻 強制アタッチ
- 🔧 固定仮想環境使用

#### 実行方法
```bash
# 起動（即座にtmux画面表示）
./start_dev_next_time.sh

# デタッチ: Ctrl+B → D
# 再アタッチ: tmux attach -t dev-env
```

#### 適用場面
- **素早い起動が必要**
- **必ずtmux画面で作業**
- **シンプル操作を好む**

---

## 🛑 開発環境停止方法

### 統一停止コマンド
```bash
# 全ての開発環境プロセスを停止
./stop_development.sh
```

### 手動停止（緊急時）
```bash
# プロセス確認
ss -tlnp | grep -E "(3001|8001)"

# 個別停止
kill $(lsof -ti:3001) 2>/dev/null || true
kill $(lsof -ti:8001) 2>/dev/null || true

# tmuxセッション停止
tmux kill-session -t dev-env
```

---

## 📊 起動方法比較表

| 項目 | 方法1: バックグラウンド | 方法2: 高機能tmux | 方法3: シンプルtmux |
|------|------------------------|-------------------|-------------------|
| **実行方式** | nohup（背景実行） | tmux（選択式） | tmux（強制） |
| **ターミナル** | 即座解放 | 選択可能 | 占有 |
| **ログ確認** | ファイル | リアルタイム | リアルタイム |
| **安全性** | 高 | 最高 | 中 |
| **起動速度** | 中 | 低（情報表示） | 高 |
| **デバッグ** | ログファイル必要 | 即座確認 | 即座確認 |
| **初心者向け** | ○ | ◎ | △ |

---

## 🔍 状況確認コマンド

### 現在実行中のプロセス確認
```bash
# ポート使用状況
ss -tlnp | grep -E "(3000|3001|8000|8001)"

# Next.jsプロセス
pgrep -fl "next"

# Pythonプロセス
pgrep -fl "python.*main"
```

### 環境変数確認
```bash
./check_environment.sh
```

### ログ確認
```bash
# 開発環境ログ
tail -f logs/backend_dev.log
tail -f logs/frontend_dev.log

# 本番環境ログ（参考）
sudo journalctl -u nagaiku-budget-backend -f
sudo journalctl -u nagaiku-budget-frontend -f
```

---

## ⚠️ トラブルシューティング

### ポート競合エラー
```bash
# 既存プロセス確認・停止
./stop_development.sh
sleep 3
./start_development.sh
```

### tmuxセッション競合
```bash
# 既存セッション強制終了
tmux kill-session -t dev-env
./start_dev_tmux.sh
```

### 仮想環境エラー
```bash
# 仮想環境確認
ls -la backend/venv backend/dev_venv

# 仮想環境再作成（必要時）
cd backend
python3 -m venv venv
source venv/bin/activate
pip install -r requirements.txt
```

### 外部アクセス不可
```bash
# 起動時に -H 0.0.0.0 フラグが必要
# 各起動スクリプトに既に含まれています
```

---

## 💡 推奨使い分け

### 🎯 用途別推奨

| 用途 | 推奨方法 | 理由 |
|------|----------|------|
| **日常開発** | 方法1（バックグラウンド） | 効率的、他作業と並行 |
| **新機能開発** | 方法2（高機能tmux） | デバッグしやすい |
| **緊急修正** | 方法3（シンプルtmux） | 高速起動 |
| **初回起動** | 方法2（高機能tmux） | 安全、詳細情報 |

### 🚀 開発フロー推奨

1. **初回**: 方法2で動作確認
2. **日常**: 方法1で効率的作業
3. **問題時**: 方法2でデバッグ

---

## 📞 サポート情報

### 関連ファイル
- `start_development.sh` - バックグラウンド起動
- `start_dev_tmux.sh` - 高機能tmux起動
- `start_dev_next_time.sh` - シンプルtmux起動
- `stop_development.sh` - 統一停止
- `check_environment.sh` - 環境確認

### 参考ドキュメント
- `docs/DEPLOY_GUIDE.md` - デプロイガイド
- `docs/SYSTEMD_GUIDE.md` - 本番環境管理
- `README.md` - プロジェクト概要

---

## 🧪 動作確認手順（環境変数完全分離対応）

### 基本的な動作確認フロー

#### 1. 開発環境を停止
```bash
./stop_development.sh
```

#### 2. systemdサービスをリロード（root権限必要）
```bash
sudo systemctl daemon-reload
```

#### 3. 本番環境を再起動（root権限必要）
```bash
sudo systemctl restart nagaiku-budget-backend nagaiku-budget-frontend
```

#### 4. 開発環境を起動
```bash
./start_dev_next_time.sh
```

#### 5. 両環境にアクセスして動作確認
- **本番環境**: http://160.251.170.97:3000
- **開発環境**: http://160.251.170.97:3001
- **開発API仕様書**: http://160.251.170.97:8001/docs

### 🔍 詳細確認項目

#### 環境分離確認
```bash
# 現在のプロセス確認
ss -tlnp | grep -E "(3000|3001|8000|8001)"

# systemdサービス状態確認
sudo systemctl status nagaiku-budget-backend
sudo systemctl status nagaiku-budget-frontend

# 開発環境tmuxセッション確認
tmux list-sessions | grep dev-env
```

#### 機能テスト項目
1. **フロントエンド表示確認**
   - 本番: レスポンシブデザイン、ナビゲーション
   - 開発: 同様の機能、開発ツール表示

2. **API接続確認**
   - 本番: データベース接続、取引一覧表示
   - 開発: 開発データベース接続確認

3. **主要機能テスト**
   - 取引データ表示・フィルター
   - 一括割当機能
   - レポート生成・CSVエクスポート

### ⚠️ 重要な注意点

#### 環境変数設定の原則
- **.env系ファイルは一切使用しません**
- **環境変数はすべて起動時に明示的に設定します**
- **これにより環境設定の混乱を完全に防げます**

#### 権限管理
- **本番環境操作**: `sudo`権限が必要（systemdサービス管理）
- **開発環境操作**: 一般ユーザー権限で実行可能
- **ファイル編集**: 一般ユーザー権限で実行可能

#### トラブルシューティング
```bash
# ポート競合時
./stop_development.sh
sudo systemctl stop nagaiku-budget-*
sleep 3
sudo systemctl start nagaiku-budget-*
./start_dev_next_time.sh

# 環境変数確認
./check_environment.sh
```

---

**💡 ヒント**: 初めての方は方法2（高機能tmux版）から始めて、慣れてきたら方法1（バックグラウンド版）に移行することをお勧めします。 
# 開発環境起動ガイド

## 概要
このガイドでは、nagaiku-budget システムの開発環境を起動する手順を説明します。

## 環境構成（統合版）
- **フロントエンド**: http://160.251.170.97:3000
- **バックエンド API**: http://160.251.170.97:8000
- **データベース**: nagaiku_budget_dev（開発用）
- **起動方法**: tmuxセッション

## 起動手順

### 1. 本番環境の停止（必要な場合）
本番環境が起動している場合は、まず停止します：

```bash
sudo systemctl stop nagaiku-budget-backend
sudo systemctl stop nagaiku-budget-frontend
```

### 2. 開発環境の起動
プロジェクトルートディレクトリで以下のコマンドを実行：

```bash
cd /home/tanaka/nagaiku-budget
./start.sh development
```

または、モード切り替えスクリプトを使用：

```bash
./switch_mode.sh development
```

### 3. 起動確認
起動が完了すると、以下のメッセージが表示されます：

```
Application is running:
  Frontend: http://160.251.170.97:3000
  Backend API: http://160.251.170.97:8000
  Production URL: https://nagaiku.top/budget/
```

### 4. 動作確認
ブラウザで以下にアクセスして動作を確認：
- **フロントエンド**: http://160.251.170.97:3000
- **設定画面**: http://160.251.170.97:3000/settings

設定画面の「システム情報」セクションで以下を確認できます：
- **データベース**: nagaiku_budget_dev
- **環境**: development
- **ポート**: 8000
- **設定ファイル**: .env.development

## ログの確認

### tmuxセッションにアタッチ
```bash
tmux attach -t nagaiku-dev
```

### tmux操作
- **ウィンドウ切り替え**: 
  - Ctrl-b + 0: バックエンド
  - Ctrl-b + 1: フロントエンド
- **デタッチ**: Ctrl-b + d

## 停止方法

### スクリプトを使用
```bash
./stop.sh
```

### 手動停止（緊急時）
```bash
# tmuxセッションを終了
tmux kill-session -t nagaiku-dev

# ポートを使用しているプロセスを確認
lsof -i:3000 -i:8000

# 必要に応じてプロセスを強制終了
kill -9 <PID>
```

## トラブルシューティング

### ポート競合エラー
```bash
Error: listen EADDRINUSE: address already in use
```

対処法：
1. `./stop.sh` を実行して全プロセスを停止
2. それでも解決しない場合は、`lsof -i:3000 -i:8000` でプロセスを確認して手動停止

### データベース接続エラー
開発用データベースが存在しない場合は、手動で作成する必要があります：

```bash
# 1. 本番DBをバックアップ
sudo -u postgres pg_dump nagaiku_budget > backups/backup_$(date +%Y%m%d_%H%M%S).sql

# 2. 開発DBを作成
sudo -u postgres createdb nagaiku_budget_dev

# 3. データをインポート
sudo -u postgres psql nagaiku_budget_dev < backups/backup_ファイル名.sql

# 4. 権限を付与
sudo -u postgres psql -c "GRANT ALL PRIVILEGES ON DATABASE nagaiku_budget_dev TO nagaiku_user;"
```

または、switch_mode.shスクリプトを使用（推奨）：
```bash
./switch_mode.sh development
```

### APIエンドポイントが見つからない
バックエンドが正しく起動していない可能性があります：
1. tmuxセッションにアタッチして、エラーログを確認
2. 必要に応じて `./stop.sh` → `./start.sh development` で再起動

### tmuxでシェルエラーが出る場合
バックエンドがsh（デフォルトシェル）で起動してしまう場合があります。
この場合、tmux内でbashに切り替えてから再実行してください：

```bash
# tmuxにアタッチ
tmux attach -t nagaiku-dev

# バックエンドウィンドウで
bash
source dev_venv/bin/activate
ENV_FILE=.env.development PORT=8000 uvicorn main:app --host 0.0.0.0 --port 8000 --reload
```

## 環境統合版の特徴

### ポート統一
- 開発環境も本番環境も同じポート（3000/8000）を使用
- 同時起動はできないため、必ず片方を停止してから起動

### データベース管理
- 開発用データベース（nagaiku_budget_dev）は手動で作成する必要があります
- switch_mode.shスクリプトを使用すると、バックアップと作成を安全に実行できます
- 開発環境では本番データベースに影響を与えません

### 環境変数管理
- `.env`（本番用）と`.env.development`（開発用）を自動切り替え
- 環境変数は起動時にスクリプトで設定されるため、手動変更不要

## 注意事項

1. **データベース分離**: 開発環境では `nagaiku_budget_dev` を使用し、本番データベースには影響しません
2. **自動バックアップ**: 開発環境起動時に本番データベースが自動的にバックアップされます（`backups/`ディレクトリ）
3. **URL構成**: 開発環境ではIPアドレス直接アクセス、本番環境ではドメイン（https://nagaiku.top/budget/）を使用
4. **環境の切り替え**: 必ず一方を停止してから、もう一方を起動してください

## 推奨ワークフロー

1. **開発開始時**
   ```bash
   # 本番環境を停止
   sudo systemctl stop nagaiku-budget-backend
   sudo systemctl stop nagaiku-budget-frontend
   
   # 開発環境を起動
   ./switch_mode.sh development
   ```

2. **開発中**
   - tmuxセッションでログを監視
   - 設定画面でデータベース接続を確認

3. **本番環境に戻す時**
   ```bash
   ./switch_mode.sh production
   ```

## 関連ドキュメント
- [本番環境起動ガイド](./本番環境起動ガイド.md)
- [CLAUDE.md](../CLAUDE.md) - プロジェクト全体の設定情報
- [環境分離ガイド（旧版）](./ENVIRONMENT_SEPARATION.md) - 参考資料
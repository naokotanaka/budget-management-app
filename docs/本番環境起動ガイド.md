# æœ¬ç•ªç’°å¢ƒèµ·å‹•ã‚¬ã‚¤ãƒ‰ - NPOäºˆç®—ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã€ŒãªãŒã„ãã€

**æœ€çµ‚æ›´æ–°æ—¥**: 2025å¹´7æœˆ21æ—¥  
**ä½œæˆè€…**: AIé–‹ç™ºã‚»ãƒƒã‚·ãƒ§ãƒ³è¨˜éŒ²

---

## ğŸ¯ æ¦‚è¦

NPOäºˆç®—ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã€ŒãªãŒã„ãã€ã®æœ¬ç•ªç’°å¢ƒèµ·å‹•æ‰‹é †ã‚’è©³ç´°ã«èª¬æ˜ã—ã¾ã™ã€‚
ä»Šå›ã®ä¿®æ­£ã«ã‚ˆã‚Šã€**äº‹å‰ãƒ“ãƒ«ãƒ‰**ã¨**é«˜é€Ÿèµ·å‹•**ã®2æ®µéšæ–¹å¼ã«ãªã‚Šã¾ã—ãŸã€‚

## ğŸ“‹ ç’°å¢ƒè¨­å®š

### ãƒãƒ¼ãƒˆè¨­å®š
- **æœ¬ç•ªç’°å¢ƒ**: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰:3000, ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰:8000
- **é–‹ç™ºç’°å¢ƒ**: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰:3001, ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰:8001

### ã‚¢ã‚¯ã‚»ã‚¹URL
- **ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰**: http://160.251.170.97:3000
- **ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰API**: http://160.251.170.97:8000
- **APIä»•æ§˜æ›¸**: http://160.251.170.97:8000/docs

---

## ğŸš€ æœ¬ç•ªç’°å¢ƒèµ·å‹•æ–¹æ³•

### **Step 1: äº‹å‰ãƒ“ãƒ«ãƒ‰ï¼ˆåˆå›ãƒ»ã‚³ãƒ¼ãƒ‰å¤‰æ›´æ™‚ã®ã¿ï¼‰**

```bash
# ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®äº‹å‰ãƒ“ãƒ«ãƒ‰ï¼ˆæ™‚é–“ãŒã‹ã‹ã‚‹å‡¦ç†ï¼‰
./build_production.sh
```

ã“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒä»¥ä¸‹ã‚’å®Ÿè¡Œã—ã¾ã™ï¼š
- æœ¬ç•ªç’°å¢ƒç”¨ç’°å¢ƒå¤‰æ•°ã®è¨­å®š
- æ—¢å­˜ãƒ“ãƒ«ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«ã®å‰Šé™¤
- ä¾å­˜é–¢ä¿‚ã®ç¢ºèª
- æœ¬ç•ªç”¨Next.jsãƒ“ãƒ«ãƒ‰

### **Step 2: systemdè¨­å®šæ›´æ–°**

```bash
# systemdè¨­å®šã‚’å†èª­ã¿è¾¼ã¿
sudo systemctl daemon-reload
```

### **Step 3: æ—¢å­˜ãƒ—ãƒ­ã‚»ã‚¹ã®ç¢ºèªãƒ»åœæ­¢**

```bash
# ç¾åœ¨ã®ãƒ—ãƒ­ã‚»ã‚¹ç¢ºèª
ss -tlnp | grep -E "(3000|8000)"

# å¿…è¦ã«å¿œã˜ã¦ç«¶åˆãƒ—ãƒ­ã‚»ã‚¹ã‚’åœæ­¢
sudo systemctl stop nagaiku-budget-backend
sudo systemctl stop nagaiku-budget-frontend

# æ‰‹å‹•èµ·å‹•ãƒ—ãƒ­ã‚»ã‚¹ãŒã‚ã‚Œã°åœæ­¢
pkill -f "next-server"
pkill -f "uvicorn.*main:app"
```

### **Step 4: æœ¬ç•ªç’°å¢ƒèµ·å‹•ï¼ˆé«˜é€Ÿï¼‰**

```bash
# ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰èµ·å‹•
sudo systemctl start nagaiku-budget-backend

# ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰èµ·å‹•ï¼ˆäº‹å‰ãƒ“ãƒ«ãƒ‰æ¸ˆã¿ãªã®ã§æ•°ç§’ã§å®Œäº†ï¼‰
sudo systemctl start nagaiku-budget-frontend
```

ã¾ãŸã¯ä¸€æ‹¬èµ·å‹•ï¼š
```bash
sudo systemctl start nagaiku-budget-backend nagaiku-budget-frontend
```

### **Step 5: å‹•ä½œç¢ºèª**

```bash
# ã‚µãƒ¼ãƒ“ã‚¹çŠ¶æ…‹ç¢ºèª
sudo systemctl status nagaiku-budget-backend --no-pager
sudo systemctl status nagaiku-budget-frontend --no-pager

# ãƒãƒ¼ãƒˆç¢ºèª
ss -tlnp | grep -E "(3000|8000)"

# ã‚¢ã‚¯ã‚»ã‚¹ç¢ºèª
curl -I http://160.251.170.97:3000  # ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰
curl -I http://160.251.170.97:8000/docs  # ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰API
```

---

## ğŸ”„ æ—¥å¸¸é‹ç”¨ï¼ˆå†èµ·å‹•æ™‚ï¼‰

ã‚³ãƒ¼ãƒ‰å¤‰æ›´ãŒãªã„å ´åˆã®å†èµ·å‹•ã¯éå¸¸ã«é«˜é€Ÿï¼š

```bash
# é«˜é€Ÿå†èµ·å‹•ï¼ˆæ•°ç§’ã§å®Œäº†ï¼‰
sudo systemctl restart nagaiku-budget-backend nagaiku-budget-frontend
```

---

## âš ï¸ ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### **ã‚ˆãã‚ã‚‹å•é¡Œã¨è§£æ±ºæ³•**

#### **1. ãƒãƒ¼ãƒˆç«¶åˆã‚¨ãƒ©ãƒ¼**
```
Error: listen EADDRINUSE: address already in use
```

**è§£æ±ºæ–¹æ³•**:
```bash
# ç«¶åˆãƒ—ãƒ­ã‚»ã‚¹ã‚’ç¢ºèª
ss -tlnp | grep -E "(3000|8000)"

# ãƒ—ãƒ­ã‚»ã‚¹ã‚’åœæ­¢
kill <PID>

# ã¾ãŸã¯ä¸€æ‹¬åœæ­¢
pkill -f "next-server"
pkill -f "uvicorn"
```

#### **2. ã‚µãƒ¼ãƒ“ã‚¹èµ·å‹•å¤±æ•—**
```
systemctl status shows "failed" or "exited"
```

**è§£æ±ºæ–¹æ³•**:
```bash
# è©³ç´°ãƒ­ã‚°ç¢ºèª
sudo journalctl -u nagaiku-budget-backend -n 20 --no-pager
sudo journalctl -u nagaiku-budget-frontend -n 20 --no-pager

# ã‚µãƒ¼ãƒ“ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹ç¢ºèª
cat /etc/systemd/system/nagaiku-budget-backend.service | grep WorkingDirectory
cat /etc/systemd/system/nagaiku-budget-frontend.service | grep WorkingDirectory
```

#### **3. WAMã‚µãƒ¼ãƒ“ã‚¹ã‚¨ãƒ©ãƒ¼**
```
WAM Service import failed or 500 errors
```

**è§£æ±ºæ–¹æ³•**:
```bash
# WAMãƒãƒƒãƒ”ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ã®åˆæœŸåŒ–
cd backend
export ENVIRONMENT=production
export PORT=8000
python3 -c "
from database import get_db, init_database
from sqlalchemy import text
from wam_service import WamService
try:
    init_database()
    db = next(get_db())
    WamService.initialize_default_mappings(db)
    result = db.execute(text('SELECT COUNT(*) FROM wam_mappings')).fetchone()
    print(f'âœ… WAMãƒãƒƒãƒ”ãƒ³ã‚°åˆæœŸåŒ–å®Œäº†: {result[0]}ä»¶')
    db.close()
except Exception as e:
    print(f'âŒ åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: {e}')
"
```

#### **4. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰é–‹ç™ºãƒ¢ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼**
```
Failed to fetch _devMiddlewareManifest.json
```

**è§£æ±ºæ–¹æ³•**:
```bash
# ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚’å†ãƒ“ãƒ«ãƒ‰
sudo systemctl stop nagaiku-budget-frontend
cd frontend
rm -rf .next
NODE_ENV=production NEXT_PUBLIC_API_URL=http://160.251.170.97:8000 npm run build
cd ..
sudo systemctl start nagaiku-budget-frontend
```

#### **5. ã‚µãƒ¼ãƒ“ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹å•é¡Œ**
```
CGroup shows wrong path like /root/nagaiku-budget-prod/
```

**è§£æ±ºæ–¹æ³•**:
```bash
# æ­£ã—ã„ã‚µãƒ¼ãƒ“ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«ã§ä¸Šæ›¸ã
cd /home/tanaka/nagaiku-budget
sudo cp nagaiku-budget-backend.service /etc/systemd/system/
sudo cp nagaiku-budget-frontend.service /etc/systemd/system/

# å¤ã„è¨­å®šã‚’å‰Šé™¤
sudo rm -rf /etc/systemd/system/nagaiku-budget-backend.service.d
sudo rm -f /etc/systemd/system/nagaiku-budget-backend.service.save

# è¨­å®šã‚’å†èª­ã¿è¾¼ã¿
sudo systemctl daemon-reload
```

### **ç·Šæ€¥æ™‚ã®å®Œå…¨ãƒªã‚»ãƒƒãƒˆ**

```bash
# 1. å…¨ã‚µãƒ¼ãƒ“ã‚¹åœæ­¢
sudo systemctl stop nagaiku-budget-backend nagaiku-budget-frontend

# 2. å…¨ãƒ—ãƒ­ã‚»ã‚¹å¼·åˆ¶åœæ­¢
sudo pkill -f "next-server"
sudo pkill -f "uvicorn"
sudo pkill -f "npm.*start"

# 3. ãƒãƒ¼ãƒˆç¢ºèª
ss -tlnp | grep -E "(3000|8000)"

# 4. ã‚µãƒ¼ãƒ“ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«å†ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
cd /home/tanaka/nagaiku-budget
sudo cp nagaiku-budget-*.service /etc/systemd/system/
sudo systemctl daemon-reload

# 5. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å†ãƒ“ãƒ«ãƒ‰
cd frontend
rm -rf .next
NODE_ENV=production NEXT_PUBLIC_API_URL=http://160.251.170.97:8000 npm run build

# 6. ã‚µãƒ¼ãƒ“ã‚¹å†èµ·å‹•
cd ..
sudo systemctl start nagaiku-budget-backend nagaiku-budget-frontend
```

---

## ğŸ“ ãƒ­ã‚°ç¢ºèª

### **ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ­ã‚°**
```bash
# ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰
sudo journalctl -u nagaiku-budget-backend -f

# ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰
sudo journalctl -u nagaiku-budget-frontend -f
```

### **ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«**
```bash
# æœ¬ç•ªç’°å¢ƒãƒ­ã‚°
tail -f logs/backend_prod.log
tail -f logs/frontend_prod.log

# é–‹ç™ºç’°å¢ƒãƒ­ã‚°ï¼ˆå‚è€ƒï¼‰
tail -f logs/backend_dev.log
tail -f logs/frontend_dev.log
```

---

## ğŸ¯ é‡è¦ãªãƒã‚¤ãƒ³ãƒˆ

### **1. ç’°å¢ƒåˆ†é›¢ã®ç¢ºå®Ÿæ€§**
- **æœ¬ç•ªç’°å¢ƒ**: ãƒãƒ¼ãƒˆ3000/8000ã€systemdã‚µãƒ¼ãƒ“ã‚¹ç®¡ç†
- **é–‹ç™ºç’°å¢ƒ**: ãƒãƒ¼ãƒˆ3001/8001ã€æ‰‹å‹•ã‚¹ã‚¯ãƒªãƒ—ãƒˆç®¡ç†
- **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹**: `nagaiku_budget`ï¼ˆæœ¬ç•ªï¼‰vs `nagaiku_budget_dev`ï¼ˆé–‹ç™ºï¼‰

### **2. èµ·å‹•é€Ÿåº¦ã®æ”¹å–„**
- **åˆå›ãƒ»ã‚³ãƒ¼ãƒ‰å¤‰æ›´æ™‚**: `./build_production.sh` â†’ `systemctl start`
- **æ—¥å¸¸ã®å†èµ·å‹•**: `systemctl restart` ã®ã¿ï¼ˆæ•°ç§’ã§å®Œäº†ï¼‰
- **äº‹å‰ãƒ“ãƒ«ãƒ‰ãªã—ã§èµ·å‹•ã™ã‚‹ã¨**: ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™

### **3. ãƒ—ãƒ­ã‚»ã‚¹ç®¡ç†ã®çµ±ä¸€**
- **æœ¬ç•ªç’°å¢ƒ**: systemdã‚µãƒ¼ãƒ“ã‚¹ã®ã¿ä½¿ç”¨
- **æ‰‹å‹•èµ·å‹•ç¦æ­¢**: æœ¬ç•ªãƒãƒ¼ãƒˆ3000/8000ã§ã®æ‰‹å‹•èµ·å‹•ã¯é¿ã‘ã‚‹
- **ç«¶åˆå›é¿**: èµ·å‹•å‰ã«æ—¢å­˜ãƒ—ãƒ­ã‚»ã‚¹ã‚’ç¢ºèªãƒ»åœæ­¢

### **4. WAMã‚µãƒ¼ãƒ“ã‚¹ã®åˆæœŸåŒ–**
- **åˆå›èµ·å‹•æ™‚**: WAMãƒãƒƒãƒ”ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ã®åˆæœŸåŒ–ãŒå¿…è¦
- **ãƒ‡ãƒ¼ã‚¿ç¢ºèª**: WAMãƒãƒƒãƒ”ãƒ³ã‚°ä»¶æ•°ã‚’ç¢ºèªï¼ˆ21ä»¶ãŒæ¨™æº–ï¼‰
- **ã‚¨ãƒ©ãƒ¼æ™‚**: åˆæœŸåŒ–ã‚¹ã‚¯ãƒªãƒ—ãƒˆã§å¾©æ—§å¯èƒ½

---

## ğŸ“Š æ”¹å–„åŠ¹æœ

| é …ç›® | ä¿®æ­£å‰ | ä¿®æ­£å¾Œ | æ”¹å–„åŠ¹æœ |
|------|--------|--------|----------|
| **èµ·å‹•æ™‚é–“** | 3-5åˆ†ï¼ˆæ¯å›ãƒ“ãƒ«ãƒ‰ï¼‰ | 5-10ç§’ï¼ˆäº‹å‰ãƒ“ãƒ«ãƒ‰æ¸ˆã¿ï¼‰ | **30-60å€é«˜é€ŸåŒ–** |
| **ãƒ—ãƒ­ã‚»ã‚¹ç®¡ç†** | æ‰‹å‹•ç®¡ç†ãƒ»ç«¶åˆå¤šç™º | systemdçµ±ä¸€ç®¡ç† | **å®‰å®šæ€§å¤§å¹…å‘ä¸Š** |
| **ã‚¨ãƒ©ãƒ¼å¯¾å¿œ** | åŸå› ä¸æ˜ãƒ»é•·æ™‚é–“åœæ­¢ | æ˜ç¢ºãªæ‰‹é †ãƒ»è¿…é€Ÿå¾©æ—§ | **é‹ç”¨åŠ¹ç‡å‘ä¸Š** |
| **ç’°å¢ƒåˆ†é›¢** | è¨­å®šæ··åœ¨ãƒ»èª¤æ“ä½œãƒªã‚¹ã‚¯ | å®Œå…¨åˆ†é›¢ãƒ»å®‰å…¨é‹ç”¨ | **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å‘ä¸Š** |

---

## ğŸ”— é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- `docs/é–‹ç™ºç’°å¢ƒèµ·å‹•ã‚¬ã‚¤ãƒ‰.md` - é–‹ç™ºç’°å¢ƒã®èµ·å‹•æ–¹æ³•
- `docs/DEPLOY_GUIDE.md` - ãƒ‡ãƒ—ãƒ­ã‚¤å…¨èˆ¬ã®ã‚¬ã‚¤ãƒ‰
- `docs/SYSTEM_SPECIFICATION.md` - ã‚·ã‚¹ãƒ†ãƒ ä»•æ§˜æ›¸
- `README.md` - ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¦‚è¦

---

## ğŸ’¡ é‹ç”¨ã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

### **å®šæœŸãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹**
```bash
# é€±æ¬¡ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹
sudo systemctl restart nagaiku-budget-backend nagaiku-budget-frontend

# æœˆæ¬¡ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹
./build_production.sh  # ã‚³ãƒ¼ãƒ‰æ›´æ–°æ™‚
sudo systemctl daemon-reload
```

### **ç›£è¦–é …ç›®**
- ã‚µãƒ¼ãƒ“ã‚¹ç¨¼åƒçŠ¶æ³: `systemctl status nagaiku-budget-*`
- ãƒãƒ¼ãƒˆä½¿ç”¨çŠ¶æ³: `ss -tlnp | grep -E "(3000|8000)"`
- ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º: `ls -lh logs/`
- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶š: WAMãƒ¬ãƒãƒ¼ãƒˆæ©Ÿèƒ½ã®å‹•ä½œç¢ºèª

### **ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—**
- ã‚³ãƒ¼ãƒ‰å¤‰æ›´å‰: Gitã‚³ãƒŸãƒƒãƒˆå¿…é ˆ
- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹: å®šæœŸçš„ãªpg_dumpå®Ÿè¡Œ
- è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«: systemdã‚µãƒ¼ãƒ“ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«ã®ä¿ç®¡

---

**ğŸ‰ ã“ã‚Œã§æœ¬ç•ªç’°å¢ƒã®å®‰å®šé‹ç”¨ãŒå¯èƒ½ã«ãªã‚Šã¾ã—ãŸï¼** 
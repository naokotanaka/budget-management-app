# 本番環境起動ガイド - NPO予算管理システム「ながいく」

**最終更新日**: 2025年7月21日  
**作成者**: AI開発セッション記録

---

## 🎯 概要

NPO予算管理システム「ながいく」の本番環境起動手順を詳細に説明します。
今回の修正により、**事前ビルド**と**高速起動**の2段階方式になりました。

## 📋 環境設定

### ポート設定
- **本番環境**: フロントエンド:3000, バックエンド:8000
- **開発環境**: フロントエンド:3001, バックエンド:8001

### アクセスURL
- **フロントエンド**: http://160.251.170.97:3000
- **バックエンドAPI**: http://160.251.170.97:8000
- **API仕様書**: http://160.251.170.97:8000/docs

---

## 🚀 本番環境起動方法

### **Step 1: 事前ビルド（初回・コード変更時のみ）**

```bash
# フロントエンドの事前ビルド（時間がかかる処理）
./build_production.sh
```

このスクリプトが以下を実行します：
- 本番環境用環境変数の設定
- 既存ビルドファイルの削除
- 依存関係の確認
- 本番用Next.jsビルド

### **Step 2: systemd設定更新**

```bash
# systemd設定を再読み込み
sudo systemctl daemon-reload
```

### **Step 3: 既存プロセスの確認・停止**

```bash
# 現在のプロセス確認
ss -tlnp | grep -E "(3000|8000)"

# 必要に応じて競合プロセスを停止
sudo systemctl stop nagaiku-budget-backend
sudo systemctl stop nagaiku-budget-frontend

# 手動起動プロセスがあれば停止
pkill -f "next-server"
pkill -f "uvicorn.*main:app"
```

### **Step 4: 本番環境起動（高速）**

```bash
# バックエンド起動
sudo systemctl start nagaiku-budget-backend

# フロントエンド起動（事前ビルド済みなので数秒で完了）
sudo systemctl start nagaiku-budget-frontend
```

または一括起動：
```bash
sudo systemctl start nagaiku-budget-backend nagaiku-budget-frontend
```

### **Step 5: 動作確認**

```bash
# サービス状態確認
sudo systemctl status nagaiku-budget-backend --no-pager
sudo systemctl status nagaiku-budget-frontend --no-pager

# ポート確認
ss -tlnp | grep -E "(3000|8000)"

# アクセス確認
curl -I http://160.251.170.97:3000  # フロントエンド
curl -I http://160.251.170.97:8000/docs  # バックエンドAPI
```

---

## 🔄 日常運用（再起動時）

コード変更がない場合の再起動は非常に高速：

```bash
# 高速再起動（数秒で完了）
sudo systemctl restart nagaiku-budget-backend nagaiku-budget-frontend
```

---

## ⚠️ トラブルシューティング

### **よくある問題と解決法**

#### **1. ポート競合エラー**
```
Error: listen EADDRINUSE: address already in use
```

**解決方法**:
```bash
# 競合プロセスを確認
ss -tlnp | grep -E "(3000|8000)"

# プロセスを停止
kill <PID>

# または一括停止
pkill -f "next-server"
pkill -f "uvicorn"
```

#### **2. サービス起動失敗**
```
systemctl status shows "failed" or "exited"
```

**解決方法**:
```bash
# 詳細ログ確認
sudo journalctl -u nagaiku-budget-backend -n 20 --no-pager
sudo journalctl -u nagaiku-budget-frontend -n 20 --no-pager

# サービスファイルのパス確認
cat /etc/systemd/system/nagaiku-budget-backend.service | grep WorkingDirectory
cat /etc/systemd/system/nagaiku-budget-frontend.service | grep WorkingDirectory
```

#### **3. WAMサービスエラー**
```
WAM Service import failed or 500 errors
```

**解決方法**:
```bash
# WAMマッピングデータの初期化
cd backend
export ENVIRONMENT=production
export PORT=8000
python3 -c "
from database import get_db, init_database
from sqlalchemy import text
from wam_service import WamService
try:
    init_database()
    db = next(get_db())
    WamService.initialize_default_mappings(db)
    result = db.execute(text('SELECT COUNT(*) FROM wam_mappings')).fetchone()
    print(f'✅ WAMマッピング初期化完了: {result[0]}件')
    db.close()
except Exception as e:
    print(f'❌ 初期化エラー: {e}')
"
```

#### **4. フロントエンド開発モードエラー**
```
Failed to fetch _devMiddlewareManifest.json
```

**解決方法**:
```bash
# フロントエンドを再ビルド
sudo systemctl stop nagaiku-budget-frontend
cd frontend
rm -rf .next
NODE_ENV=production NEXT_PUBLIC_API_URL=http://160.251.170.97:8000 npm run build
cd ..
sudo systemctl start nagaiku-budget-frontend
```

#### **5. サービスファイルパス問題**
```
CGroup shows wrong path like /root/nagaiku-budget-prod/
```

**解決方法**:
```bash
# 正しいサービスファイルで上書き
cd /home/tanaka/nagaiku-budget
sudo cp nagaiku-budget-backend.service /etc/systemd/system/
sudo cp nagaiku-budget-frontend.service /etc/systemd/system/

# 古い設定を削除
sudo rm -rf /etc/systemd/system/nagaiku-budget-backend.service.d
sudo rm -f /etc/systemd/system/nagaiku-budget-backend.service.save

# 設定を再読み込み
sudo systemctl daemon-reload
```

### **緊急時の完全リセット**

```bash
# 1. 全サービス停止
sudo systemctl stop nagaiku-budget-backend nagaiku-budget-frontend

# 2. 全プロセス強制停止
sudo pkill -f "next-server"
sudo pkill -f "uvicorn"
sudo pkill -f "npm.*start"

# 3. ポート確認
ss -tlnp | grep -E "(3000|8000)"

# 4. サービスファイル再インストール
cd /home/tanaka/nagaiku-budget
sudo cp nagaiku-budget-*.service /etc/systemd/system/
sudo systemctl daemon-reload

# 5. フロントエンド再ビルド
cd frontend
rm -rf .next
NODE_ENV=production NEXT_PUBLIC_API_URL=http://160.251.170.97:8000 npm run build

# 6. サービス再起動
cd ..
sudo systemctl start nagaiku-budget-backend nagaiku-budget-frontend
```

---

## 📝 ログ確認

### **リアルタイムログ**
```bash
# バックエンド
sudo journalctl -u nagaiku-budget-backend -f

# フロントエンド
sudo journalctl -u nagaiku-budget-frontend -f
```

### **ログファイル**
```bash
# 本番環境ログ
tail -f logs/backend_prod.log
tail -f logs/frontend_prod.log

# 開発環境ログ（参考）
tail -f logs/backend_dev.log
tail -f logs/frontend_dev.log
```

---

## 🎯 重要なポイント

### **1. 環境分離の確実性**
- **本番環境**: ポート3000/8000、systemdサービス管理
- **開発環境**: ポート3001/8001、手動スクリプト管理
- **データベース**: `nagaiku_budget`（本番）vs `nagaiku_budget_dev`（開発）

### **2. 起動速度の改善**
- **初回・コード変更時**: `./build_production.sh` → `systemctl start`
- **日常の再起動**: `systemctl restart` のみ（数秒で完了）
- **事前ビルドなしで起動すると**: エラーになる可能性があります

### **3. プロセス管理の統一**
- **本番環境**: systemdサービスのみ使用
- **手動起動禁止**: 本番ポート3000/8000での手動起動は避ける
- **競合回避**: 起動前に既存プロセスを確認・停止

### **4. WAMサービスの初期化**
- **初回起動時**: WAMマッピングデータの初期化が必要
- **データ確認**: WAMマッピング件数を確認（21件が標準）
- **エラー時**: 初期化スクリプトで復旧可能

---

## 📊 改善効果

| 項目 | 修正前 | 修正後 | 改善効果 |
|------|--------|--------|----------|
| **起動時間** | 3-5分（毎回ビルド） | 5-10秒（事前ビルド済み） | **30-60倍高速化** |
| **プロセス管理** | 手動管理・競合多発 | systemd統一管理 | **安定性大幅向上** |
| **エラー対応** | 原因不明・長時間停止 | 明確な手順・迅速復旧 | **運用効率向上** |
| **環境分離** | 設定混在・誤操作リスク | 完全分離・安全運用 | **セキュリティ向上** |

---

## 🔗 関連ドキュメント

- `docs/開発環境起動ガイド.md` - 開発環境の起動方法
- `docs/DEPLOY_GUIDE.md` - デプロイ全般のガイド
- `docs/SYSTEM_SPECIFICATION.md` - システム仕様書
- `README.md` - プロジェクト概要

---

## 💡 運用のベストプラクティス

### **定期メンテナンス**
```bash
# 週次メンテナンス
sudo systemctl restart nagaiku-budget-backend nagaiku-budget-frontend

# 月次メンテナンス
./build_production.sh  # コード更新時
sudo systemctl daemon-reload
```

### **監視項目**
- サービス稼働状況: `systemctl status nagaiku-budget-*`
- ポート使用状況: `ss -tlnp | grep -E "(3000|8000)"`
- ログファイルサイズ: `ls -lh logs/`
- データベース接続: WAMレポート機能の動作確認

### **バックアップ**
- コード変更前: Gitコミット必須
- データベース: 定期的なpg_dump実行
- 設定ファイル: systemdサービスファイルの保管

---

**🎉 これで本番環境の安定運用が可能になりました！** 
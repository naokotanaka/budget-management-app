# 本番環境デプロイガイド - NPO予算管理システム「ながいく」

**最終更新日**: 2025年7月21日  
**作成者**: AI開発セッション記録

---

## 🎯 概要

NPO予算管理システム「ながいく」の本番環境への完全なデプロイ手順を説明します。
Git管理、バックアップ、権限切り替え、安全なデプロイプロセスを含む包括的なガイドです。

## 📋 前提条件

### **システム要件**
- **サーバー**: VPS (160.251.170.97)
- **OS**: Linux (Ubuntu/Debian系)
- **ユーザー**: `tanaka` (開発用) / `root` (システム管理用)
- **データベース**: PostgreSQL
- **Node.js**: v18以上
- **Python**: 3.12以上

### **アクセス権限**
- **開発作業**: `tanaka` ユーザー
- **システム管理**: `root` ユーザー (sudo権限)
- **プロジェクト場所**: `/home/tanaka/nagaiku-budget/`

---

## ⚡ 簡単デプロイ（日常更新用）

### **前提条件**
- 大きな変更がない日常的な更新
- データベースマイグレーションが不要
- 依存関係の変更がない

### **簡単3ステップ**

```bash
# 1. 開発環境で確認・Git更新
./stop_development.sh
git add . && git commit -m "fix: 軽微な修正" && git push

# 2. 本番環境更新（root権限で）
sudo su -
cd /home/tanaka/nagaiku-budget
git pull origin main
./build_production.sh
systemctl restart nagaiku-budget-backend nagaiku-budget-frontend

# 3. 動作確認
curl -I http://160.251.170.97:3000
curl -I http://160.251.170.97:8000/docs
exit  # root権限から抜ける
```

### **さらに簡単！ワンライナー版**

```bash
# 開発環境での確認後、以下を実行
sudo bash -c "cd /home/tanaka/nagaiku-budget && git pull && ./build_production.sh && systemctl restart nagaiku-budget-*"
```

---

## 🚀 完全デプロイ手順

### **Phase 1: 事前準備とバックアップ**

#### **1-1. 開発環境での最終確認**

```bash
# 開発環境で動作確認
./start_dev_next_time.sh

# アクセステスト
curl -I http://160.251.170.97:3001  # 開発フロントエンド
curl -I http://160.251.170.97:8001/docs  # 開発API

# 開発環境停止
./stop_development.sh
```

#### **1-2. Gitコミット・プッシュ**

```bash
# 変更状況確認
git status

# 変更をステージング
git add .

# コミット（Conventional Commits形式）
git commit -m "feat: 新機能追加とバグ修正

- 機能A: 詳細説明
- 修正B: 問題の解決
- 改善C: パフォーマンス向上

Closes #123"

# リモートにプッシュ
git push origin main

# コミットハッシュを記録
git log --oneline -5
```

#### **1-3. データベースバックアップ（重要）**

```bash
# バックアップディレクトリ作成
mkdir -p backups

# 本番データベースバックアップ
PGPASSWORD=nagaiku_password2024 pg_dump -U nagaiku_user -h localhost -d nagaiku_budget > backups/backup_prod_$(date +%Y%m%d_%H%M%S).sql

# 開発データベースバックアップ（念のため）
PGPASSWORD=nagaiku_password2024 pg_dump -U nagaiku_user -h localhost -d nagaiku_budget_dev > backups/backup_dev_$(date +%Y%m%d_%H%M%S).sql

# バックアップ確認
ls -lh backups/backup_*$(date +%Y%m%d)*.sql
```

#### **1-4. 現在の状況記録**

```bash
# 現在のプロセス状況を記録
ss -tlnp | grep -E "(3000|3001|8000|8001)" > logs/deploy_pre_$(date +%Y%m%d_%H%M%S).log

# サービス状況を記録
systemctl status nagaiku-budget-* >> logs/deploy_pre_$(date +%Y%m%d_%H%M%S).log
```

---

### **Phase 2: 本番環境への切り替え**

#### **2-1. root権限への切り替え**

```bash
# rootユーザーに切り替え
sudo su -

# または直接root権限でコマンド実行
sudo -i

# プロジェクトディレクトリに移動
cd /home/tanaka/nagaiku-budget
```

#### **2-2. 既存サービス停止**

```bash
# 現在の状況確認
systemctl status nagaiku-budget-backend nagaiku-budget-frontend

# 本番サービス停止
systemctl stop nagaiku-budget-backend
systemctl stop nagaiku-budget-frontend

# 競合プロセスの強制停止
pkill -f "next-server"
pkill -f "uvicorn"
pkill -f "npm.*start"

# ポート解放確認
ss -tlnp | grep -E "(3000|8000)"
```

#### **2-3. Gitからの最新コード取得**

```bash
# Gitユーザー設定（rootで実行時）
git config --global user.name "System Deploy"
git config --global user.email "deploy@nagaiku-budget.local"

# 最新コードを取得
git fetch origin
git checkout main
git pull origin main

# 変更内容確認
git log --oneline -5
git diff HEAD~1 --name-only
```

---

### **Phase 3: 依存関係とビルド**

#### **3-1. バックエンド依存関係更新**

```bash
cd backend

# 仮想環境の確認・作成
if [ ! -d "venv" ]; then
    python3 -m venv venv
fi

# 仮想環境有効化
source venv/bin/activate

# 依存関係更新
pip install --upgrade pip
pip install -r requirements.txt

# 依存関係確認
pip list | grep -E "(fastapi|sqlalchemy|pandas)"

cd ..
```

#### **3-2. フロントエンド依存関係更新**

```bash
cd frontend

# Node.jsバージョン確認
node --version
npm --version

# 依存関係更新（セキュリティ更新含む）
npm ci --production=false

# 脆弱性チェック
npm audit fix

cd ..
```

#### **3-3. データベースマイグレーション（必要時）**

```bash
# データベース接続確認
cd backend
export ENVIRONMENT=production
export PORT=8000

python3 -c "
from database import get_db, init_database
try:
    init_database()
    db = next(get_db())
    print('✅ データベース接続成功')
    db.close()
except Exception as e:
    print(f'❌ データベース接続エラー: {e}')
"

cd ..
```

---

### **Phase 4: 本番ビルドとデプロイ**

#### **4-1. 本番環境ビルド**

```bash
# 本番ビルド実行
./build_production.sh

# ビルド結果確認
ls -la frontend/.next/
ls -la frontend/.next/static/
```

#### **4-2. systemdサービス設定更新**

```bash
# サービスファイル更新
cp nagaiku-budget-backend.service /etc/systemd/system/
cp nagaiku-budget-frontend.service /etc/systemd/system/

# 古い設定削除
rm -rf /etc/systemd/system/nagaiku-budget-backend.service.d
rm -f /etc/systemd/system/nagaiku-budget-backend.service.save

# 設定再読み込み
systemctl daemon-reload

# サービスファイル確認
systemctl cat nagaiku-budget-backend
systemctl cat nagaiku-budget-frontend
```

#### **4-3. ログディレクトリ準備**

```bash
# ログディレクトリ作成・権限設定
mkdir -p logs
chown tanaka:tanaka logs/
chmod 755 logs/

# 古いログローテーション
if [ -f "logs/backend_prod.log" ] && [ $(stat -f%z "logs/backend_prod.log" 2>/dev/null || stat -c%s "logs/backend_prod.log") -gt 10485760 ]; then
    mv logs/backend_prod.log logs/backend_prod_$(date +%Y%m%d_%H%M%S).log
fi

if [ -f "logs/frontend_prod.log" ] && [ $(stat -f%z "logs/frontend_prod.log" 2>/dev/null || stat -c%s "logs/frontend_prod.log") -gt 10485760 ]; then
    mv logs/frontend_prod.log logs/frontend_prod_$(date +%Y%m%d_%H%M%S).log
fi
```

---

### **Phase 5: サービス起動と確認**

#### **5-1. 本番サービス起動**

```bash
# バックエンド起動
systemctl start nagaiku-budget-backend
sleep 5

# フロントエンド起動
systemctl start nagaiku-budget-frontend
sleep 5

# サービス状態確認
systemctl status nagaiku-budget-backend --no-pager
systemctl status nagaiku-budget-frontend --no-pager
```

#### **5-2. 動作確認**

```bash
# ポート確認
ss -tlnp | grep -E "(3000|8000)"

# ヘルスチェック
curl -I http://160.251.170.97:8000/docs
curl -I http://160.251.170.97:3000

# APIエンドポイント確認
curl -s http://160.251.170.97:8000/api/debug/db-info | head -5
```

#### **5-3. ログ確認**

```bash
# 起動ログ確認
journalctl -u nagaiku-budget-backend -n 20 --no-pager
journalctl -u nagaiku-budget-frontend -n 20 --no-pager

# エラーチェック
journalctl -u nagaiku-budget-backend --since "5 minutes ago" | grep -i error
journalctl -u nagaiku-budget-frontend --since "5 minutes ago" | grep -i error
```

---

### **Phase 6: 機能テストと最終確認**

#### **6-1. 基本機能テスト**

```bash
# データベース接続テスト
curl -s "http://160.251.170.97:8000/api/transactions?limit=1" | head -10

# API機能テスト
curl -s "http://160.251.170.97:8000/api/transactions?limit=1" | head -5
```

#### **6-2. ブラウザテスト項目**

以下のURLに順次アクセスして動作確認：

1. **フロントエンド**: http://160.251.170.97:3000
   - ページ読み込み確認
   - ナビゲーション動作確認

2. **取引管理**: http://160.251.170.97:3000/transactions
   - 取引データ表示確認
   - フィルター機能確認

3. **レポート機能**: http://160.251.170.97:3000/wam-report
   - 各種レポート表示確認
   - エラーがないか確認

4. **API仕様書**: http://160.251.170.97:8000/docs
   - Swagger UI表示確認
   - API動作確認

#### **6-3. パフォーマンステスト**

```bash
# レスポンス時間測定
time curl -s http://160.251.170.97:3000 > /dev/null
time curl -s http://160.251.170.97:8000/docs > /dev/null

# メモリ使用量確認
systemctl status nagaiku-budget-backend --no-pager | grep Memory
systemctl status nagaiku-budget-frontend --no-pager | grep Memory
```

---

### **Phase 7: 後処理と文書化**

#### **7-1. デプロイ記録**

```bash
# デプロイ完了記録
cat > logs/deploy_$(date +%Y%m%d_%H%M%S).log << EOF
=== デプロイ完了記録 ===
日時: $(date)
コミット: $(git log --oneline -1)
バックアップ: $(ls -1t backups/backup_prod_*.sql | head -1)
サービス状態:
$(systemctl status nagaiku-budget-backend --no-pager)
$(systemctl status nagaiku-budget-frontend --no-pager)
EOF
```

#### **7-2. 権限を元に戻す**

```bash
# ファイル所有者を確認・修正
chown -R tanaka:tanaka /home/tanaka/nagaiku-budget/

# 実行権限確認
chmod +x /home/tanaka/nagaiku-budget/*.sh

# rootセッション終了
exit  # rootから抜ける
```

#### **7-3. 開発環境の復旧確認**

```bash
# 通常ユーザーに戻って開発環境確認
cd /home/tanaka/nagaiku-budget

# 開発環境が正常に起動できるか確認
./start_dev_next_time.sh
# Ctrl+B → D でデタッチ

# 開発環境停止
./stop_development.sh
```

---

## ⚠️ トラブルシューティング

### **デプロイ中のよくある問題**

#### **1. Git関連の問題**
```bash
# Git競合解決
git stash
git pull origin main
git stash pop

# 権限問題
chown -R tanaka:tanaka .git/
```

#### **2. 依存関係の問題**
```bash
# Node.js依存関係問題
rm -rf frontend/node_modules
rm frontend/package-lock.json
cd frontend && npm install

# Python依存関係問題
cd backend
rm -rf venv
python3 -m venv venv
source venv/bin/activate
pip install -r requirements.txt
```

#### **3. ビルドエラー**
```bash
# Next.jsビルドエラー
cd frontend
rm -rf .next
NODE_ENV=production NEXT_PUBLIC_API_URL=http://160.251.170.97:8000 npm run build

# TypeScriptエラー無視
npm run build -- --no-lint
```

#### **4. データベース接続エラー**
```bash
# PostgreSQL状態確認
systemctl status postgresql

# 接続テスト
PGPASSWORD=nagaiku_password2024 psql -U nagaiku_user -h localhost -d nagaiku_budget -c "SELECT 1;"
```

#### **5. systemdサービスエラー**
```bash
# サービスログ詳細確認
journalctl -u nagaiku-budget-backend -f
journalctl -u nagaiku-budget-frontend -f

# サービス再起動
systemctl daemon-reload
systemctl restart nagaiku-budget-backend nagaiku-budget-frontend
```

---

## 🔄 ロールバック手順

### **緊急時のロールバック**

```bash
# 1. サービス停止
sudo systemctl stop nagaiku-budget-backend nagaiku-budget-frontend

# 2. 前のコミットに戻る
git log --oneline -10
git checkout <前のコミットハッシュ>

# 3. 依存関係復旧
cd backend && source venv/bin/activate && pip install -r requirements.txt
cd ../frontend && npm ci

# 4. ビルド実行
./build_production.sh

# 5. サービス再起動
sudo systemctl start nagaiku-budget-backend nagaiku-budget-frontend
```

### **データベースロールバック**

```bash
# データベース復旧（最新バックアップから）
BACKUP_FILE=$(ls -1t backups/backup_prod_*.sql | head -1)
PGPASSWORD=nagaiku_password2024 psql -U nagaiku_user -h localhost -d nagaiku_budget < $BACKUP_FILE
```

---

## 📊 デプロイチェックリスト

### **事前確認**
- [ ] 開発環境での動作確認完了
- [ ] Gitコミット・プッシュ完了
- [ ] データベースバックアップ完了
- [ ] 現在の状況記録完了

### **デプロイ実行**
- [ ] root権限への切り替え完了
- [ ] 既存サービス停止完了
- [ ] 最新コード取得完了
- [ ] 依存関係更新完了
- [ ] 本番ビルド完了
- [ ] systemdサービス設定更新完了

### **動作確認**
- [ ] サービス起動確認
- [ ] ポート確認
- [ ] ヘルスチェック完了
- [ ] ブラウザテスト完了
- [ ] ログエラーチェック完了

### **後処理**
- [ ] デプロイ記録作成
- [ ] 権限復旧完了
- [ ] 開発環境確認完了

---

## 🚨 緊急連絡先・エスカレーション

### **問題発生時の対応**

1. **軽微な問題**: ログ確認・サービス再起動
2. **重大な問題**: ロールバック実行
3. **データベース問題**: バックアップからの復旧
4. **システム全体問題**: 開発環境での代替運用

### **連絡体制**
- **システム管理者**: 即座対応
- **開発チーム**: 技術的問題対応
- **利用者**: 問題発生時の通知

---

## 💡 デプロイのベストプラクティス

### **定期デプロイ**
- **頻度**: 週1回（金曜日午後推奨）
- **時間**: 利用者の少ない時間帯
- **準備**: 事前テスト・バックアップ必須

### **緊急デプロイ**
- **条件**: セキュリティ修正・重大バグ修正
- **手順**: 最小限の変更・即座の動作確認
- **通知**: 関係者への事前・事後通知

### **品質管理**
- **コードレビュー**: 重要な変更は複数人でレビュー
- **テスト**: 開発環境での十分なテスト
- **文書化**: 変更内容の明確な記録

---

**🎉 これで安全で確実なデプロイが可能になりました！**

このガイドに従うことで、リスクを最小限に抑えた本番環境へのデプロイが実現できます。 
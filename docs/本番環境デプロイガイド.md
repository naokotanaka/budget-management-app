# æœ¬ç•ªç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤ã‚¬ã‚¤ãƒ‰ - NPOäºˆç®—ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã€ŒãªãŒã„ãã€

**æœ€çµ‚æ›´æ–°æ—¥**: 2025å¹´7æœˆ21æ—¥  
**ä½œæˆè€…**: AIé–‹ç™ºã‚»ãƒƒã‚·ãƒ§ãƒ³è¨˜éŒ²

---

## ğŸ¯ æ¦‚è¦

NPOäºˆç®—ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã€ŒãªãŒã„ãã€ã®æœ¬ç•ªç’°å¢ƒã¸ã®å®Œå…¨ãªãƒ‡ãƒ—ãƒ­ã‚¤æ‰‹é †ã‚’èª¬æ˜ã—ã¾ã™ã€‚
Gitç®¡ç†ã€ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã€æ¨©é™åˆ‡ã‚Šæ›¿ãˆã€å®‰å…¨ãªãƒ‡ãƒ—ãƒ­ã‚¤ãƒ—ãƒ­ã‚»ã‚¹ã‚’å«ã‚€åŒ…æ‹¬çš„ãªã‚¬ã‚¤ãƒ‰ã§ã™ã€‚

## ğŸ“‹ å‰ææ¡ä»¶

### **ã‚·ã‚¹ãƒ†ãƒ è¦ä»¶**
- **ã‚µãƒ¼ãƒãƒ¼**: VPS (160.251.170.97)
- **OS**: Linux (Ubuntu/Debianç³»)
- **ãƒ¦ãƒ¼ã‚¶ãƒ¼**: `tanaka` (é–‹ç™ºç”¨) / `root` (ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†ç”¨)
- **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹**: PostgreSQL
- **Node.js**: v18ä»¥ä¸Š
- **Python**: 3.12ä»¥ä¸Š

### **ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™**
- **é–‹ç™ºä½œæ¥­**: `tanaka` ãƒ¦ãƒ¼ã‚¶ãƒ¼
- **ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†**: `root` ãƒ¦ãƒ¼ã‚¶ãƒ¼ (sudoæ¨©é™)
- **ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå ´æ‰€**: `/home/tanaka/nagaiku-budget/`

---

## âš¡ ç°¡å˜ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆæ—¥å¸¸æ›´æ–°ç”¨ï¼‰

### **å‰ææ¡ä»¶**
- å¤§ããªå¤‰æ›´ãŒãªã„æ—¥å¸¸çš„ãªæ›´æ–°
- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãŒä¸è¦
- ä¾å­˜é–¢ä¿‚ã®å¤‰æ›´ãŒãªã„

### **ç°¡å˜3ã‚¹ãƒ†ãƒƒãƒ—**

```bash
# 1. é–‹ç™ºç’°å¢ƒã§ç¢ºèªãƒ»Gitæ›´æ–°
./stop_development.sh
git add . && git commit -m "fix: è»½å¾®ãªä¿®æ­£" && git push

# 2. æœ¬ç•ªç’°å¢ƒæ›´æ–°
cd /home/tanaka/nagaiku-budget
git pull origin main
./build_production.sh

# 3. å‹•ä½œç¢ºèª
```

### **ã•ã‚‰ã«ç°¡å˜ï¼ãƒ¯ãƒ³ãƒ©ã‚¤ãƒŠãƒ¼ç‰ˆ**

```bash
# é–‹ç™ºç’°å¢ƒã§ã®ç¢ºèªå¾Œã€ä»¥ä¸‹ã‚’å®Ÿè¡Œ
sudo bash -c "cd /home/tanaka/nagaiku-budget && git pull && ./build_production.sh && systemctl restart nagaiku-budget-*"
```

---

## ğŸš€ å®Œå…¨ãƒ‡ãƒ—ãƒ­ã‚¤æ‰‹é †

### **Phase 1: äº‹å‰æº–å‚™ã¨ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—**

#### **1-1. é–‹ç™ºç’°å¢ƒã§ã®æœ€çµ‚ç¢ºèª**

```bash
# é–‹ç™ºç’°å¢ƒã§å‹•ä½œç¢ºèª
./start_dev_next_time.sh

# ã‚¢ã‚¯ã‚»ã‚¹ãƒ†ã‚¹ãƒˆ
curl -I http://160.251.170.97:3001  # é–‹ç™ºãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰
curl -I http://160.251.170.97:8001/docs  # é–‹ç™ºAPI

# é–‹ç™ºç’°å¢ƒåœæ­¢
./stop_development.sh
```

#### **1-2. Gitã‚³ãƒŸãƒƒãƒˆãƒ»ãƒ—ãƒƒã‚·ãƒ¥**

```bash
# å¤‰æ›´çŠ¶æ³ç¢ºèª
git status

# å¤‰æ›´ã‚’ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°
git add .

# ã‚³ãƒŸãƒƒãƒˆï¼ˆConventional Commitså½¢å¼ï¼‰
git commit -m "æ›´æ–°: å–å¼•ä¸€è¦§ã®è¡¨ç¤ºæ”¹å–„"

# ãƒªãƒ¢ãƒ¼ãƒˆã«ãƒ—ãƒƒã‚·ãƒ¥
git push origin main

# ã‚³ãƒŸãƒƒãƒˆãƒãƒƒã‚·ãƒ¥ã‚’è¨˜éŒ²
git log --oneline -5
```

#### **1-3. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼ˆé‡è¦ï¼‰**

```bash
# ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
mkdir -p backups

# æœ¬ç•ªãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
PGPASSWORD=nagaiku_password2024 pg_dump -U nagaiku_user -h localhost -d nagaiku_budget > backups/backup_prod_$(date +%Y%m%d_%H%M%S).sql

# é–‹ç™ºãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼ˆå¿µã®ãŸã‚ï¼‰
PGPASSWORD=nagaiku_password2024 pg_dump -U nagaiku_user -h localhost -d nagaiku_budget_dev > backups/backup_dev_$(date +%Y%m%d_%H%M%S).sql

# ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ç¢ºèª
ls -lh backups/backup_*$(date +%Y%m%d)*.sql
```

#### **1-4. ç¾åœ¨ã®çŠ¶æ³è¨˜éŒ²**

```bash
# ç¾åœ¨ã®ãƒ—ãƒ­ã‚»ã‚¹çŠ¶æ³ã‚’è¨˜éŒ²
ss -tlnp | grep -E "(3000|3001|8000|8001)" > logs/deploy_pre_$(date +%Y%m%d_%H%M%S).log

# ã‚µãƒ¼ãƒ“ã‚¹çŠ¶æ³ã‚’è¨˜éŒ²
systemctl status nagaiku-budget-* >> logs/deploy_pre_$(date +%Y%m%d_%H%M%S).log
```

---

### **Phase 2: æœ¬ç•ªç’°å¢ƒã¸ã®åˆ‡ã‚Šæ›¿ãˆ**

#### **2-1. rootæ¨©é™ã¸ã®åˆ‡ã‚Šæ›¿ãˆ**

```bash
# rootãƒ¦ãƒ¼ã‚¶ãƒ¼ã«åˆ‡ã‚Šæ›¿ãˆ
sudo su -

# ã¾ãŸã¯ç›´æ¥rootæ¨©é™ã§ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œ
sudo -i

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç§»å‹•
cd /home/tanaka/nagaiku-budget
```

#### **2-2. æ—¢å­˜ã‚µãƒ¼ãƒ“ã‚¹åœæ­¢**

```bash
# ç¾åœ¨ã®çŠ¶æ³ç¢ºèª
systemctl status nagaiku-budget-backend nagaiku-budget-frontend

# æœ¬ç•ªã‚µãƒ¼ãƒ“ã‚¹åœæ­¢
systemctl stop nagaiku-budget-backend
systemctl stop nagaiku-budget-frontend

# ã€é‡è¦ã€‘ç«¶åˆãƒ—ãƒ­ã‚»ã‚¹ã®ç¢ºèªãƒ»å¼·åˆ¶åœæ­¢
# ç‰¹ã«rootãƒ—ãƒ­ã‚»ã‚¹ã«ã‚ˆã‚‹ãƒãƒ¼ãƒˆå æœ‰ã‚’ãƒã‚§ãƒƒã‚¯
lsof -i :8000
lsof -i :3000

# ç«¶åˆãƒ—ãƒ­ã‚»ã‚¹å¼·åˆ¶åœæ­¢ï¼ˆPIDã‚’ç¢ºèªã—ã¦ã‹ã‚‰å®Ÿè¡Œï¼‰
pkill -f "python.*main.py"
pkill -f "next-server"
pkill -f "uvicorn"
pkill -f "npm.*start"

# ãƒãƒ¼ãƒˆè§£æ”¾ç¢ºèªï¼ˆé‡è¦ï¼‰
ss -tlnp | grep -E "(3000|8000)"
# å‡ºåŠ›ãŒç©ºã«ãªã‚‹ã“ã¨ã‚’ç¢ºèª
```

#### **2-3. Gitã‹ã‚‰ã®æœ€æ–°ã‚³ãƒ¼ãƒ‰å–å¾—**

```bash
# tanakaãƒ¦ãƒ¼ã‚¶ãƒ¼ã«åˆ‡ã‚Šæ›¿ãˆã¦Gitæ“ä½œå®Ÿè¡Œ
su - tanaka -c "cd /home/tanaka/nagaiku-budget && git fetch origin && git checkout main && git pull origin main"

# å¤‰æ›´å†…å®¹ç¢ºèª
cd /home/tanaka/nagaiku-budget
git log --oneline -5
git diff HEAD~1 --name-only

# ç‰¹ã«é‡è¦: æœ¬ç•ªç’°å¢ƒï¼ˆmain.pyï¼‰ã¨é–‹ç™ºç’°å¢ƒï¼ˆmain_dev_8001.pyï¼‰ã®å·®åˆ†ç¢ºèª
git diff HEAD~1 backend/main.py
git diff HEAD~1 backend/main_dev_8001.py
```

---

### **Phase 3: ä¾å­˜é–¢ä¿‚ã¨ãƒ“ãƒ«ãƒ‰**

#### **3-1. ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ä¾å­˜é–¢ä¿‚æ›´æ–°**

```bash
cd backend

# ä»®æƒ³ç’°å¢ƒã®ç¢ºèªãƒ»ä½œæˆ
if [ ! -d "venv" ]; then
    python3 -m venv venv
fi

# ä»®æƒ³ç’°å¢ƒæœ‰åŠ¹åŒ–
. venv/bin/activate

# ä¾å­˜é–¢ä¿‚æ›´æ–°
pip install --upgrade pip
pip install -r requirements.txt

# ä¾å­˜é–¢ä¿‚ç¢ºèª
pip list | grep -E "(fastapi|sqlalchemy|pandas)"

cd ..
```

#### **3-2. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ä¾å­˜é–¢ä¿‚æ›´æ–°**

```bash
cd frontend

# Node.jsãƒãƒ¼ã‚¸ãƒ§ãƒ³ç¢ºèª
node --version
npm --version

# ä¾å­˜é–¢ä¿‚æ›´æ–°ï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ›´æ–°å«ã‚€ï¼‰
npm ci --production=false

# è„†å¼±æ€§ãƒã‚§ãƒƒã‚¯
npm audit fix

cd ..
```

#### **3-3. ç’°å¢ƒåˆ†é›¢ç¢ºèªã¨APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆåŒæœŸ**

```bash
# ã€é‡è¦ã€‘æœ¬ç•ªç’°å¢ƒã¨é–‹ç™ºç’°å¢ƒã®APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆå·®åˆ†ç¢ºèª
echo "=== APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆå·®åˆ†ãƒã‚§ãƒƒã‚¯ ==="
grep -n "@app\.get\|@app\.post\|@app\.put\|@app\.delete" backend/main.py > /tmp/prod_endpoints.txt
grep -n "@app\.get\|@app\.post\|@app\.put\|@app\.delete" backend/main_dev_8001.py > /tmp/dev_endpoints.txt

echo "æœ¬ç•ªç’°å¢ƒã«ã®ã¿å­˜åœ¨ã™ã‚‹ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ:"
diff /tmp/dev_endpoints.txt /tmp/prod_endpoints.txt | grep ">" || echo "ãªã—"

echo "é–‹ç™ºç’°å¢ƒã«ã®ã¿å­˜åœ¨ã™ã‚‹ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ:"
diff /tmp/dev_endpoints.txt /tmp/prod_endpoints.txt | grep "<" || echo "ãªã—"

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šç¢ºèª
cd backend
export ENVIRONMENT=production
export PORT=8000
export DATABASE_URL=postgresql://nagaiku_user:nagaiku_password2024@localhost:5432/nagaiku_budget

python3 -c "
from database import get_db, init_database
try:
    init_database()
    db = next(get_db())
    print('âœ… ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šæˆåŠŸ')
    db.close()
except Exception as e:
    print(f'âŒ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šã‚¨ãƒ©ãƒ¼: {e}')
"

cd ..
```

---

### **Phase 4: æœ¬ç•ªãƒ“ãƒ«ãƒ‰ã¨ãƒ‡ãƒ—ãƒ­ã‚¤**

#### **4-1. æœ¬ç•ªç’°å¢ƒãƒ“ãƒ«ãƒ‰**

```bash
# æœ¬ç•ªãƒ“ãƒ«ãƒ‰å®Ÿè¡Œ
./build_production.sh

# ãƒ“ãƒ«ãƒ‰çµæœç¢ºèª
ls -la frontend/.next/
ls -la frontend/.next/static/
```

#### **4-2. systemdã‚µãƒ¼ãƒ“ã‚¹è¨­å®šæ›´æ–°**

```bash
# ã‚µãƒ¼ãƒ“ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«æ›´æ–°
cp nagaiku-budget-backend.service /etc/systemd/system/
cp nagaiku-budget-frontend.service /etc/systemd/system/

# ã€é‡è¦ã€‘ç’°å¢ƒå¤‰æ•°è¨­å®šç¢ºèª
echo "=== ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚µãƒ¼ãƒ“ã‚¹ç’°å¢ƒå¤‰æ•°ç¢ºèª ==="
grep -A 10 "Environment=" /etc/systemd/system/nagaiku-budget-backend.service

echo "=== å¿…é ˆç’°å¢ƒå¤‰æ•°ãƒã‚§ãƒƒã‚¯ ==="
grep -q "ENVIRONMENT=production" /etc/systemd/system/nagaiku-budget-backend.service && echo "âœ… ENVIRONMENTè¨­å®šæ¸ˆã¿" || echo "âŒ ENVIRONMENTæœªè¨­å®š"
grep -q "PORT=8000" /etc/systemd/system/nagaiku-budget-backend.service && echo "âœ… PORTè¨­å®šæ¸ˆã¿" || echo "âŒ PORTæœªè¨­å®š"
grep -q "DATABASE_URL=" /etc/systemd/system/nagaiku-budget-backend.service && echo "âœ… DATABASE_URLè¨­å®šæ¸ˆã¿" || echo "âŒ DATABASE_URLæœªè¨­å®š"

# è¨­å®šå†èª­ã¿è¾¼ã¿
systemctl daemon-reload

# ã‚µãƒ¼ãƒ“ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«ç¢ºèª
systemctl cat nagaiku-budget-backend | grep -A 5 Environment=
```

#### **4-3. ãƒ­ã‚°ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæº–å‚™**

```bash
# ãƒ­ã‚°ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆãƒ»æ¨©é™è¨­å®š
mkdir -p logs
chown tanaka:tanaka logs/
chmod 755 logs/

# å¤ã„ãƒ­ã‚°ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³
if [ -f "logs/backend_prod.log" ] && [ $(stat -f%z "logs/backend_prod.log" 2>/dev/null || stat -c%s "logs/backend_prod.log") -gt 10485760 ]; then
    mv logs/backend_prod.log logs/backend_prod_$(date +%Y%m%d_%H%M%S).log
fi

if [ -f "logs/frontend_prod.log" ] && [ $(stat -f%z "logs/frontend_prod.log" 2>/dev/null || stat -c%s "logs/frontend_prod.log") -gt 10485760 ]; then
    mv logs/frontend_prod.log logs/frontend_prod_$(date +%Y%m%d_%H%M%S).log
fi
```

---

### **Phase 5: ã‚µãƒ¼ãƒ“ã‚¹èµ·å‹•ã¨ç¢ºèª**

#### **5-1. æœ¬ç•ªã‚µãƒ¼ãƒ“ã‚¹èµ·å‹•**

```bash
# ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰èµ·å‹•
systemctl start nagaiku-budget-backend
sleep 5

# ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰èµ·å‹•
systemctl start nagaiku-budget-frontend
sleep 5

# ã‚µãƒ¼ãƒ“ã‚¹çŠ¶æ…‹ç¢ºèª
systemctl status nagaiku-budget-backend --no-pager
systemctl status nagaiku-budget-frontend --no-pager
```

#### **5-2. å‹•ä½œç¢ºèª**

```bash
# ãƒãƒ¼ãƒˆç¢ºèª
ss -tlnp | grep -E "(3000|8000)"

# ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
curl -I http://160.251.170.97:8000/docs
curl -I http://160.251.170.97:3000

# ã€é‡è¦ã€‘APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆç¢ºèª
echo "=== ç’°å¢ƒè¨­å®šç¢ºèª ==="
curl -s http://160.251.170.97:8000/api/debug/db-info

echo "=== åŸºæœ¬APIç¢ºèª ==="
curl -s "http://160.251.170.97:8000/api/transactions?limit=1" | head -5

echo "=== å•é¡Œã¨ãªã£ãŸã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆç¢ºèª ==="
curl -I "http://160.251.170.97:8000/api/reports/category-cross-table?start_date=2025-04-01&end_date=2026-03-31"

echo "=== ãƒ¬ãƒãƒ¼ãƒˆç³»ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆç¢ºèª ==="
curl -I "http://160.251.170.97:8000/api/reports/cross-table?start_date=2025-04-01&end_date=2026-03-31"
curl -I "http://160.251.170.97:8000/api/reports/monthly-summary?start_date=2025-04-01&end_date=2026-03-31"
```

#### **5-3. ãƒ­ã‚°ç¢ºèª**

```bash
# èµ·å‹•ãƒ­ã‚°ç¢ºèª
journalctl -u nagaiku-budget-backend -n 20 --no-pager
journalctl -u nagaiku-budget-frontend -n 20 --no-pager

# ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯
journalctl -u nagaiku-budget-backend --since "5 minutes ago" | grep -i error
journalctl -u nagaiku-budget-frontend --since "5 minutes ago" | grep -i error
```

---

### **Phase 6: æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆã¨æœ€çµ‚ç¢ºèª**

#### **6-1. åŸºæœ¬æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ**

```bash
# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šãƒ†ã‚¹ãƒˆ
curl -s "http://160.251.170.97:8000/api/transactions?limit=1" | head -10

# APIæ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ
curl -s "http://160.251.170.97:8000/api/transactions?limit=1" | head -5
```

#### **6-2. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å‹•ä½œç¢ºèª**

```bash
# ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®åŸºæœ¬å‹•ä½œç¢ºèª
echo "=== ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å¿œç­”ç¢ºèª ==="
curl -I http://160.251.170.97:3000

echo "=== ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯ ==="
echo "ãƒ–ãƒ©ã‚¦ã‚¶ã§ http://160.251.170.97:3000 ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã€é–‹ç™ºè€…ãƒ„ãƒ¼ãƒ«ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ã‚¨ãƒ©ãƒ¼ãŒãªã„ã‹ç¢ºèª"
echo "ç‰¹ã«ä»¥ä¸‹ã®ç¢ºèªãŒé‡è¦ï¼š"
echo "- å–å¼•ä¸€è¦§ãƒšãƒ¼ã‚¸ï¼ˆ404ã‚¨ãƒ©ãƒ¼ãŒãªã„ã‹ï¼‰"
echo "- ãƒ¬ãƒãƒ¼ãƒˆæ©Ÿèƒ½ï¼ˆAPIã‚¨ãƒ©ãƒ¼ãŒãªã„ã‹ï¼‰"
echo "- WAMãƒ¬ãƒãƒ¼ãƒˆæ©Ÿèƒ½ï¼ˆå…¨ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãŒå¿œç­”ã™ã‚‹ã‹ï¼‰"
```

#### **6-3. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ**

```bash
# ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚é–“æ¸¬å®š
time curl -s http://160.251.170.97:3000 > /dev/null
time curl -s http://160.251.170.97:8000/docs > /dev/null

# ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ç¢ºèª
systemctl status nagaiku-budget-backend --no-pager | grep Memory
systemctl status nagaiku-budget-frontend --no-pager | grep Memory
```

---

### **Phase 7: å¾Œå‡¦ç†ã¨æ–‡æ›¸åŒ–**

#### **7-1. ãƒ‡ãƒ—ãƒ­ã‚¤è¨˜éŒ²**

```bash
# ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†è¨˜éŒ²
cat > logs/deploy_$(date +%Y%m%d_%H%M%S).log << EOF
=== ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†è¨˜éŒ² ===
æ—¥æ™‚: $(date)
ã‚³ãƒŸãƒƒãƒˆ: $(git log --oneline -1)
ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—: $(ls -1t backups/backup_prod_*.sql | head -1)
ã‚µãƒ¼ãƒ“ã‚¹çŠ¶æ…‹:
$(systemctl status nagaiku-budget-backend --no-pager)
$(systemctl status nagaiku-budget-frontend --no-pager)
EOF
```

#### **7-2. æ¨©é™ã‚’å…ƒã«æˆ»ã™**

```bash
# ãƒ•ã‚¡ã‚¤ãƒ«æ‰€æœ‰è€…ã‚’ç¢ºèªãƒ»ä¿®æ­£
chown -R tanaka:tanaka /home/tanaka/nagaiku-budget/

# å®Ÿè¡Œæ¨©é™ç¢ºèª
chmod +x /home/tanaka/nagaiku-budget/*.sh

# rootã‚»ãƒƒã‚·ãƒ§ãƒ³çµ‚äº†
exit  # rootã‹ã‚‰æŠœã‘ã‚‹
```

#### **7-3. é–‹ç™ºç’°å¢ƒã®å¾©æ—§ç¢ºèª**

```bash
# é€šå¸¸ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«æˆ»ã£ã¦é–‹ç™ºç’°å¢ƒç¢ºèª
cd /home/tanaka/nagaiku-budget

# é–‹ç™ºç’°å¢ƒãŒæ­£å¸¸ã«èµ·å‹•ã§ãã‚‹ã‹ç¢ºèª
./start_dev_next_time.sh
# Ctrl+B â†’ D ã§ãƒ‡ã‚¿ãƒƒãƒ

# é–‹ç™ºç’°å¢ƒåœæ­¢
./stop_development.sh
```

---

## ğŸ›¡ï¸ ä»Šå›ã®å•é¡Œã‚’äºˆé˜²ã™ã‚‹ãŸã‚ã®é‡è¦ãƒã‚§ãƒƒã‚¯

### **ãƒ‡ãƒ—ãƒ­ã‚¤å‰ã®å¿…é ˆç¢ºèªäº‹é …**

```bash
# 1. APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆåŒæœŸç¢ºèª
echo "=== é–‹ç™ºç’°å¢ƒã¨æœ¬ç•ªç’°å¢ƒã®APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆå·®åˆ†ç¢ºèª ==="
diff <(grep "@app\." backend/main_dev_8001.py | sort) <(grep "@app\." backend/main.py | sort)

# 2. ç’°å¢ƒå¤‰æ•°è¨­å®šç¢ºèª
echo "=== systemdã‚µãƒ¼ãƒ“ã‚¹ç’°å¢ƒå¤‰æ•°ç¢ºèª ==="
grep -A 15 "Environment=" nagaiku-budget-backend.service

# 3. ãƒ—ãƒ­ã‚»ã‚¹ç«¶åˆç¢ºèª
echo "=== ãƒãƒ¼ãƒˆä½¿ç”¨çŠ¶æ³ç¢ºèª ==="
lsof -i :8000 -i :3000

# 4. Gitæ¨©é™ç¢ºèª
echo "=== Gitæ“ä½œæ¨©é™ç¢ºèª ==="
ls -la .git/config
whoami
```

### **ã‚ˆãã‚ã‚‹å¤±æ•—ãƒ‘ã‚¿ãƒ¼ãƒ³ã¨å¯¾ç­–**

1. **APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ404ã‚¨ãƒ©ãƒ¼**
   - **åŸå› **: é–‹ç™ºç’°å¢ƒã«ã‚ã‚‹ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãŒæœ¬ç•ªç’°å¢ƒã«ãªã„
   - **å¯¾ç­–**: ãƒ‡ãƒ—ãƒ­ã‚¤å‰ã«APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆå·®åˆ†ç¢ºèªã‚’å®Ÿæ–½

2. **ç’°å¢ƒå¤‰æ•°æ··ä¹±**
   - **åŸå› **: systemdã‚µãƒ¼ãƒ“ã‚¹ã®ç’°å¢ƒå¤‰æ•°è¨­å®šä¸è¶³
   - **å¯¾ç­–**: å¿…é ˆç’°å¢ƒå¤‰æ•°ï¼ˆENVIRONMENT, PORT, DATABASE_URLï¼‰ã®è¨­å®šç¢ºèª

3. **ãƒãƒ¼ãƒˆç«¶åˆã‚¨ãƒ©ãƒ¼**
   - **åŸå› **: æ—¢å­˜ãƒ—ãƒ­ã‚»ã‚¹ï¼ˆç‰¹ã«rootãƒ—ãƒ­ã‚»ã‚¹ï¼‰ã«ã‚ˆã‚‹ãƒãƒ¼ãƒˆå æœ‰
   - **å¯¾ç­–**: ãƒ‡ãƒ—ãƒ­ã‚¤å‰ã®å¿…é ˆãƒãƒ¼ãƒˆè§£æ”¾ç¢ºèª

4. **Gitæ¨©é™ã‚¨ãƒ©ãƒ¼**
   - **åŸå› **: rootãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ã®Gitæ“ä½œã«ã‚ˆã‚‹æ¨©é™å•é¡Œ
   - **å¯¾ç­–**: tanakaãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ã®Gitæ“ä½œå®Ÿæ–½

---

## âš ï¸ ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### **ãƒ‡ãƒ—ãƒ­ã‚¤ä¸­ã®ã‚ˆãã‚ã‚‹å•é¡Œ**

#### **1. Gité–¢é€£ã®å•é¡Œ**
```bash
# Gitç«¶åˆè§£æ±º
git stash
git pull origin main
git stash pop

# æ¨©é™å•é¡Œ
chown -R tanaka:tanaka .git/
```

#### **2. ä¾å­˜é–¢ä¿‚ã®å•é¡Œ**
```bash
# Node.jsä¾å­˜é–¢ä¿‚å•é¡Œ
rm -rf frontend/node_modules
rm frontend/package-lock.json
cd frontend && npm install

# Pythonä¾å­˜é–¢ä¿‚å•é¡Œ
cd backend
rm -rf venv
python3 -m venv venv
source venv/bin/activate
pip install -r requirements.txt
```

#### **3. ãƒ“ãƒ«ãƒ‰ã‚¨ãƒ©ãƒ¼**
```bash
# Next.jsãƒ“ãƒ«ãƒ‰ã‚¨ãƒ©ãƒ¼
cd frontend
rm -rf .next
NODE_ENV=production NEXT_PUBLIC_API_URL=http://160.251.170.97:8000 npm run build

# TypeScriptã‚¨ãƒ©ãƒ¼ç„¡è¦–
npm run build -- --no-lint
```

#### **4. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šã‚¨ãƒ©ãƒ¼**
```bash
# PostgreSQLçŠ¶æ…‹ç¢ºèª
systemctl status postgresql

# æ¥ç¶šãƒ†ã‚¹ãƒˆ
PGPASSWORD=nagaiku_password2024 psql -U nagaiku_user -h localhost -d nagaiku_budget -c "SELECT 1;"
```

#### **5. systemdã‚µãƒ¼ãƒ“ã‚¹ã‚¨ãƒ©ãƒ¼**
```bash
# ã‚µãƒ¼ãƒ“ã‚¹ãƒ­ã‚°è©³ç´°ç¢ºèª
journalctl -u nagaiku-budget-backend -f
journalctl -u nagaiku-budget-frontend -f

# ã‚µãƒ¼ãƒ“ã‚¹å†èµ·å‹•
systemctl daemon-reload
systemctl restart nagaiku-budget-backend nagaiku-budget-frontend
```

---

## ğŸ”„ ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æ‰‹é †

### **ç·Šæ€¥æ™‚ã®ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯**

```bash
# 1. ã‚µãƒ¼ãƒ“ã‚¹åœæ­¢
sudo systemctl stop nagaiku-budget-backend nagaiku-budget-frontend

# 2. å‰ã®ã‚³ãƒŸãƒƒãƒˆã«æˆ»ã‚‹
git log --oneline -10
git checkout <å‰ã®ã‚³ãƒŸãƒƒãƒˆãƒãƒƒã‚·ãƒ¥>

# 3. ä¾å­˜é–¢ä¿‚å¾©æ—§
cd backend && source venv/bin/activate && pip install -r requirements.txt
cd ../frontend && npm ci

# 4. ãƒ“ãƒ«ãƒ‰å®Ÿè¡Œ
./build_production.sh

# 5. ã‚µãƒ¼ãƒ“ã‚¹å†èµ·å‹•
sudo systemctl start nagaiku-budget-backend nagaiku-budget-frontend
```

### **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯**

```bash
# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å¾©æ—§ï¼ˆæœ€æ–°ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‹ã‚‰ï¼‰
BACKUP_FILE=$(ls -1t backups/backup_prod_*.sql | head -1)
PGPASSWORD=nagaiku_password2024 psql -U nagaiku_user -h localhost -d nagaiku_budget < $BACKUP_FILE
```

---

## ğŸ“Š ãƒ‡ãƒ—ãƒ­ã‚¤ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

### **äº‹å‰ç¢ºèª**
- [ ] é–‹ç™ºç’°å¢ƒã§ã®å‹•ä½œç¢ºèªå®Œäº†
- [ ] Gitã‚³ãƒŸãƒƒãƒˆãƒ»ãƒ—ãƒƒã‚·ãƒ¥å®Œäº†
- [ ] ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å®Œäº†
- [ ] ç¾åœ¨ã®çŠ¶æ³è¨˜éŒ²å®Œäº†

### **ãƒ‡ãƒ—ãƒ­ã‚¤å®Ÿè¡Œ**
- [ ] rootæ¨©é™ã¸ã®åˆ‡ã‚Šæ›¿ãˆå®Œäº†
- [ ] ã€é‡è¦ã€‘æ—¢å­˜ã‚µãƒ¼ãƒ“ã‚¹åœæ­¢ãƒ»ãƒãƒ¼ãƒˆè§£æ”¾ç¢ºèªå®Œäº†
- [ ] tanakaãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ã®Gitæ“ä½œå®Œäº†
- [ ] ã€é‡è¦ã€‘APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆå·®åˆ†ç¢ºèªå®Œäº†
- [ ] ä¾å­˜é–¢ä¿‚æ›´æ–°å®Œäº†
- [ ] æœ¬ç•ªãƒ“ãƒ«ãƒ‰å®Œäº†
- [ ] ã€é‡è¦ã€‘systemdç’°å¢ƒå¤‰æ•°è¨­å®šç¢ºèªå®Œäº†

### **å‹•ä½œç¢ºèª**
- [ ] ã‚µãƒ¼ãƒ“ã‚¹èµ·å‹•ç¢ºèª
- [ ] ãƒãƒ¼ãƒˆç¢ºèª
- [ ] ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å®Œäº†
- [ ] ã€é‡è¦ã€‘ç’°å¢ƒè¨­å®šAPIç¢ºèªå®Œäº†
- [ ] ã€é‡è¦ã€‘ãƒ¬ãƒãƒ¼ãƒˆç³»APIç¢ºèªå®Œäº†
- [ ] ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯å®Œäº†
- [ ] ãƒ­ã‚°ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯å®Œäº†

### **å¾Œå‡¦ç†**
- [ ] ãƒ‡ãƒ—ãƒ­ã‚¤è¨˜éŒ²ä½œæˆ
- [ ] æ¨©é™å¾©æ—§å®Œäº†
- [ ] é–‹ç™ºç’°å¢ƒç¢ºèªå®Œäº†

---

## ğŸš¨ ç·Šæ€¥é€£çµ¡å…ˆãƒ»ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³

### **å•é¡Œç™ºç”Ÿæ™‚ã®å¯¾å¿œ**

1. **è»½å¾®ãªå•é¡Œ**: ãƒ­ã‚°ç¢ºèªãƒ»ã‚µãƒ¼ãƒ“ã‚¹å†èµ·å‹•
2. **é‡å¤§ãªå•é¡Œ**: ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Ÿè¡Œ
3. **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å•é¡Œ**: ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‹ã‚‰ã®å¾©æ—§
4. **ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“å•é¡Œ**: é–‹ç™ºç’°å¢ƒã§ã®ä»£æ›¿é‹ç”¨

### **é€£çµ¡ä½“åˆ¶**
- **ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€…**: å³åº§å¯¾å¿œ
- **é–‹ç™ºãƒãƒ¼ãƒ **: æŠ€è¡“çš„å•é¡Œå¯¾å¿œ
- **åˆ©ç”¨è€…**: å•é¡Œç™ºç”Ÿæ™‚ã®é€šçŸ¥

---

## ğŸ’¡ ãƒ‡ãƒ—ãƒ­ã‚¤ã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

### **å®šæœŸãƒ‡ãƒ—ãƒ­ã‚¤**
- **é »åº¦**: é€±1å›ï¼ˆé‡‘æ›œæ—¥åˆå¾Œæ¨å¥¨ï¼‰
- **æ™‚é–“**: åˆ©ç”¨è€…ã®å°‘ãªã„æ™‚é–“å¸¯
- **æº–å‚™**: äº‹å‰ãƒ†ã‚¹ãƒˆãƒ»ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å¿…é ˆ

### **ç·Šæ€¥ãƒ‡ãƒ—ãƒ­ã‚¤**
- **æ¡ä»¶**: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¿®æ­£ãƒ»é‡å¤§ãƒã‚°ä¿®æ­£
- **æ‰‹é †**: æœ€å°é™ã®å¤‰æ›´ãƒ»å³åº§ã®å‹•ä½œç¢ºèª
- **é€šçŸ¥**: é–¢ä¿‚è€…ã¸ã®äº‹å‰ãƒ»äº‹å¾Œé€šçŸ¥

### **å“è³ªç®¡ç†**
- **ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼**: é‡è¦ãªå¤‰æ›´ã¯è¤‡æ•°äººã§ãƒ¬ãƒ“ãƒ¥ãƒ¼
- **ãƒ†ã‚¹ãƒˆ**: é–‹ç™ºç’°å¢ƒã§ã®ååˆ†ãªãƒ†ã‚¹ãƒˆ
- **æ–‡æ›¸åŒ–**: å¤‰æ›´å†…å®¹ã®æ˜ç¢ºãªè¨˜éŒ²

---

**ğŸ‰ ã“ã‚Œã§å®‰å…¨ã§ç¢ºå®Ÿãªãƒ‡ãƒ—ãƒ­ã‚¤ãŒå¯èƒ½ã«ãªã‚Šã¾ã—ãŸï¼**

ã“ã®ã‚¬ã‚¤ãƒ‰ã«å¾“ã†ã“ã¨ã§ã€ãƒªã‚¹ã‚¯ã‚’æœ€å°é™ã«æŠ‘ãˆãŸæœ¬ç•ªç’°å¢ƒã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå®Ÿç¾ã§ãã¾ã™ã€‚ 
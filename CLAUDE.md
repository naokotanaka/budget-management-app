# NPO予算管理システム - 開発メモ

## サーバー起動設定

### フロントエンド
- **正しい起動コマンド**: `npm run dev -- -H 0.0.0.0 -p 3001`
- **アクセスURL**: http://160.251.170.97:3001
- **注意**: 外部アクセスには必ず `-H 0.0.0.0` が必要
- **ポート範囲**: 3000-3010を使用

### バックエンド
- **起動スクリプト**: `/root/nagaiku-budget/backend/restart_backend.sh`
- **ポート**: 8000 (古いコード、権限問題により再起動困難)
- **更新済みポート**: 8001, 8002 (新しいフィールド対応済み)
- **自動再起動**: 有効

## トラブルシューティング

### フロントエンドが外部からアクセスできない場合
1. プロセス確認: `pgrep -fl "next"`
2. 古いプロセス停止: `kill [PID]`
3. 正しいコマンドで再起動: `npm run dev -- -H 0.0.0.0 -p 3001`
4. ポート確認: `ss -tlnp | grep 3001`

### よくある問題
- `localhost`や`127.0.0.1`では外部アクセス不可
- プロセス重複によるポート競合
- ポート80は管理者権限が必要

## システム構成
- フロントエンド: Next.js (TypeScript)
- バックエンド: FastAPI (Python)
- データベース: PostgreSQL
- 取引データ: 585件

## 未完了タスク

### 新しいフィールド対応完了状況
- [x] データベーススキーマ更新 (grant_code, remarks列追加)
- [x] バックエンドAPI更新 (main.py, schemas.py, database.py)
- [x] フロントエンド型定義更新 (api.ts)
- [x] 助成金管理ページのUI更新 (新しい列とフォーム)
- [x] CSVエクスポート機能更新 (新しい列を含む)
- [x] CSVインポート機能更新 (新旧フォーマット対応)
- [ ] **バックエンドの運用環境でのデプロイ** (権限問題により困難)

### 現在の状況
- **問題**: ポート8000の古いバックエンドプロセスが権限問題により更新困難
- **解決策**: 新しいポート(8001, 8002)で更新済みバックエンドが稼働中
- **必要な対応**: フロントエンドが新しいバックエンドに正常にアクセスできるよう設定

### テスト項目
- [ ] 割当データCSVの部分アップロード機能をテスト
  - 必須4列（ID、取引ID、予算項目ID、金額）のみでアップロード可能か確認
  - 実装場所: `/root/nagaiku-budget/backend/main.py:413`
  - 部分データでも正常動作することを確認済み（理論上）

## 関連ドキュメント
- 改善提案リスト: `/home/tanaka/nagaiku-budget/IMPROVEMENT_PROPOSALS.md`